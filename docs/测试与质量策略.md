# 智能化共享租赁平台测试与质量策略

## 当前进展
- `backend/product-service`：`ProductServiceIntegrationTest` 走通商品草稿→方案/SKU→库存调整→管理员审核→ Catalog 查询的端到端流程，`ProductInquiryServiceTest` 验证 72 小时咨询有效期、通知触发与厂商回复链路。
- `backend/order-service`：`RentalOrderServiceIntegrationTest` 覆盖购物车合并、库存预占/释放、支付回执、续租/退租/买断、纠纷申诉复核、巡检请求与信用奖励、电子合同与 `OrderMaintenanceScheduler` 自动取消；`OrderAnalyticsServiceIntegrationTest` 校验 `/analytics/**` 聚合。
- `backend/order-service`：新增 `OrderProofServiceIntegrationTest`（多角色取证上传/下载、站内信提醒）、`OrderSurveyServiceIntegrationTest`（满意度调研调度与提交）、`OrderProofServiceIntegrationTest`（多渠道通知兜底）、`RentalOrderServiceLazyLoadingTest` 和 `OrderQueryLazyLoadingTest`（校验 Web 层读取订单时不会触发懒加载异常），并通过 `OrderServiceApplicationTests` 覆盖基础启动与配置。
- `backend/order-service`：`VendorPerformanceServiceTest` 以真实订单与事件时间戳验证“支付→发货 48 小时”准时率计算，确保 SLA 抽成依据可回放。
- `backend/payment-service`：`PaymentTransactionServiceIntegrationTest`（自动确认+结算+退款）与 `PaymentTransactionServiceManualFlowTest`（手动确认、失败回调）双路径稳定运行。
- `backend/notification-service`：`NotificationServiceIntegrationTest` 验证模板渲染、Redis 缓存、自定义消息发送与日志持久化，`OrderEventListener` 监听 RabbitMQ `order.events.notification` 推送“新订单”提醒。
- `backend/auth-service`：`AuthServiceApplicationTests` 覆盖注册/登录/刷新/密码重置，确保默认管理员与角色初始化逻辑可重放。
- `backend/user-service`：`UserServiceApplicationTests` 验证厂商入驻提交、管理员审批后调用认证中心内部接口，并覆盖资料维护、管理员冻结与 `/api/v1/internal/users/{id}/credit-events` 的信用事件回写。
- `backend/product-service`：新增 `InventoryReservationConcurrencyTest` 以 32 线程×20 次请求压测库存预占逻辑，可直接执行 `./mvnw -pl backend/product-service -am -Dtest=InventoryReservationConcurrencyTest -Dsurefire.failIfNoSpecifiedTests=false test` 运行。
- 各后端模块保留 `SpringBootTest` 级上下文加载测试，默认基于 H2 + Flyway 初始化 schema，确保服务可在隔离环境中启动。
- 前端提供 Playwright E2E（`frontend/e2e/flexlease.e2e.spec.ts`）覆盖旅程 A-F（入驻、审核、咨询、下单、履约、纠纷裁决、结算/看板/通知），可用 `npm run test:e2e`（headless）或 `npm run test:e2e -- --headed`（三窗口演示）验证关键闭环。
- 多角色管理端（消费者/厂商/管理员）在 E2E 与手工回归下持续验证，依赖自动支付模拟保证演示体验一致性。

## 1. 测试金字塔（目标）
1. **单元测试（≥60%）**：聚焦领域服务、状态流转与输入校验，优先覆盖商品与订单核心逻辑。
2. **集成测试（约30%）**：使用 Spring Boot Test + H2（模拟 PostgreSQL schema）+ MockBeans 验证跨组件交互，待资源允许再逐步接入 Testcontainers（PostgreSQL/Redis/MQ）补齐外部依赖。
3. **端到端测试（约10%）**：以浏览器自动化或脚本化走查验证核心用户旅程，覆盖仪表盘、厂商商品管理/订单履约与消费者订单详情等场景。
4. **高并发回归**：执行 `./mvnw -pl backend/product-service -am -Dtest=InventoryReservationConcurrencyTest -Dsurefire.failIfNoSpecifiedTests=false test` 调用 `InventoryReservationConcurrencyTest`，验证乐观锁 + 自动重试参数在库存写入冲突明显的场景下仍可完成 600+ 次请求。

## 2. 关键测试场景
- **认证（已覆盖部分）**：登录成功、失败提示、`/auth/me` token 校验（待补单测）。
- **厂商入驻（已覆盖业务流程）**：提交、重复校验、审批触发认证服务内部接口（后续补集成测试）。
- **商品（已通过集成测试验证）**：商品审核前不可上架、SKU 唯一性、库存调整记录。
- **订单（已覆盖）**：迭代 3 中新增订单全流程集成测试，覆盖下单→支付→发货→续租→退租闭环，并校验买断失败场景；管理员分支增加强制关闭、分页检索等回归用例。
- **沟通/取证/纠纷/调研（新增）**：进一步通过 `OrderProofServiceIntegrationTest`、`OrderDisputeService` 集成回归与 `OrderSurveyServiceIntegrationTest` 覆盖订单留言、凭证上传、纠纷仲裁/申诉复核、满意度调查的多角色权限与通知链路。
- **商品咨询（新增）**：验证 `/catalog/products/{id}/inquiries` 与 `/vendors/{vendorId}/inquiries` 的提交/回复/过期逻辑，确保 72 小时窗口与通知联动有效（当前通过集成测试 + 手工回归保证）。
- **信用激励与凭证策略（新增）**：在订单成功支付、提前归还、巡检配合、纠纷友好协商与超时取消等场景检查 `CreditRewardService` 是否调用 `/credit-events` 并推送站内信；同时确认 `/proof-policy` 返回的最小凭证数、水印示例与前端展示保持一致。
- **支付/通知（已补充）**：支付服务校验退款窗口与分账，通知服务模拟渠道校验并记录日志，后续将扩展多渠道与失败重试测试。
- **运营指标（已覆盖）**：订单服务提供运营仪表盘指标聚合测试，验证平台与厂商维度统计准确性。

## 3. 质量保障措施
- 代码规范：后端采用 Spotless/Checkstyle 计划中；目前依赖 IDE 格式化，后续将补充统一规则。前端计划引入 ESLint + Prettier。
- 静态扫描：已在 IDE 中使用 SonarLint，GitHub Actions 工作流（`.github/workflows/ci.yml`）会执行 Maven Verify 与前端构建，确保关键路径可在 PR 阶段被验证。
- CI 流程：后端作业在容器化 PostgreSQL 下运行 `./mvnw clean verify`，前端作业执行 `npm ci` 与 `npm run build` 并缓存依赖；端到端脚本（Playwright）可按需在 CI 环境启用（本地默认通过 Compose 联调）。
- 合并策略：以迭代推进为主，要求至少 1 人 review 及通过现有测试。
- 指标目标：迭代 3 前后端核心模块单测覆盖 ≥ 60%，关键业务（订单、支付）分支覆盖 ≥ 80%。

## 4. 测试数据与环境
- 后端集成测试默认使用 H2 内存库模拟 PostgreSQL schema；若需验证真实数据库行为，可直接执行 `docker compose up --build` 启动容器化 PostgreSQL，并为目标服务设置 `SPRING_PROFILES_ACTIVE=postgres`。
- `docker-compose.yml` 已提供 PostgreSQL/Redis/RabbitMQ，可用于 CI 与本地联调。
- 测试账号：默认通过注册接口创建，固定账号与数据种子将在后续迁移脚本中提供。
- 数据隔离：测试使用独立 schema，Flyway 自动初始化；执行前需清理残留数据。

## 5. 发布前验证清单（草案）
- 手工回归：厂商注册→入驻→创建商品→管理员审核→前台查询→消费者提交“下单前咨询”并由厂商回复→订单履约上传凭证检验 `/proof-policy` 限制。
- 自动化：商品、订单、支付、通知及运营指标相关集成测试需全部通过；前端关键流依据发布计划执行脚本化回归或人工走查。
- 性能与安全：迭代 4 起准备压测基线与 OWASP ZAP 被动扫描，同时在订单模块通过 `RentalOrderServiceLazyLoadingTest`/`OrderQueryLazyLoadingTest` 确认懒加载安全。

## 6. 监控与日志
- 日志：统一使用 JSON 格式，接入 ELK（开发阶段可使用 Loki + Grafana）。
- 监控指标：
  - 认证成功率、登录失败次数
  - 订单状态流转耗时
  - 支付成功率、退款成功率
  - MQ 堆积长度
