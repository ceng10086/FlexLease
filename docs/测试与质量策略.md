# 智能化共享租赁平台测试与质量策略

## 当前进展
- `backend/product-service` 已编写端到端集成测试 `ProductServiceIntegrationTest`，覆盖商品从草稿到上架的完整生命周期（包含库存调整）。
- `backend/order-service` 增加集成测试 `RentalOrderServiceIntegrationTest`，验证从下单预览、创建、支付、发货、续租到退租的完整闭环，并通过 Mock 的 `PaymentClient` 校验支付凭证一致性及异常分支（买断校验、支付凭证校验）。
- `backend/order-service` 新增 `OrderAnalyticsServiceIntegrationTest`，验证运营指标聚合逻辑（总量、GMV、状态分布）与厂商维度统计。
- `backend/payment-service` 提供集成测试 `PaymentTransactionServiceIntegrationTest`，覆盖支付创建、确认、退款与结算聚合，并验证退款时间窗过滤与净入账计算。
- `backend/notification-service` 编写 `NotificationServiceIntegrationTest`，验证模板渲染、自定义消息发送、邮箱格式校验与日志持久化。
- 各后端模块保留 `SpringBootTest` 级别的上下文加载测试，确保基础配置可启动。
- 前端新增 Playwright 端到端测试 `tests/dashboard.spec.ts`，模拟鉴权与运营指标接口，确保仪表盘可以展示核心指标。

## 1. 测试金字塔（目标）
1. **单元测试（≥60%）**：聚焦领域服务、状态流转与输入校验，优先覆盖商品与订单核心逻辑。
2. **集成测试（约30%）**：使用 Spring Boot Test + Testcontainers（PostgreSQL、Redis、消息队列）对跨组件交互进行验证，现阶段优先保障认证、厂商入驻与商品域。
3. **端到端测试（约10%）**：使用 Playwright 或 Cypress 完成核心用户旅程；迭代 2 后待补充厂商创建商品与管理员审核的回归脚本。

## 2. 关键测试场景
- **认证（已覆盖部分）**：登录成功、失败提示、`/auth/me` token 校验（待补单测）。
- **厂商入驻（已覆盖业务流程）**：提交、重复校验、审批触发认证服务内部接口（后续补集成测试）。
- **商品（已通过集成测试验证）**：商品审核前不可上架、SKU 唯一性、库存调整记录。
- **订单（已覆盖）**：迭代 3 中新增订单全流程集成测试，覆盖下单→支付→发货→续租→退租闭环，并校验买断失败场景。
- **支付/通知（已补充）**：支付服务校验退款窗口与分账，通知服务模拟渠道校验并记录日志，待后续扩展多渠道与失败重试测试。
- **运营指标（已覆盖）**：订单服务提供运营仪表盘指标聚合测试，验证平台与厂商维度统计准确性。

## 3. 质量保障措施
- 代码规范：后端采用 Spotless/Checkstyle 计划中；目前依赖 IDE 格式化，后续将补充统一规则。前端计划引入 ESLint + Prettier。
- 静态扫描：已在 IDE 中使用 SonarLint，GitHub Actions CI 草稿待补充测试与构建步骤。
- CI 建议流程：`mvn clean verify` → `npm run build` → 自动化测试（待实现）。
- 合并策略：以迭代推进为主，要求至少 1 人 review 及通过现有测试。
- 指标目标：迭代 3 前后端核心模块单测覆盖 ≥ 60%，关键业务（订单、支付）分支覆盖 ≥ 80%。

## 4. 测试数据与环境
- 后端集成测试默认使用 H2 内存库模拟 PostgreSQL schema，后续切换至 Testcontainers 真实环境。
- 计划在 `docker-compose` 中补充 PostgreSQL、Redis、RabbitMQ，用于本地联调与测试。
- 测试账号：默认通过注册接口创建，固定账号与数据种子将在后续迁移脚本中提供。
- 数据隔离：测试使用独立 schema，Flyway 自动初始化；执行前需清理残留数据。

## 5. 发布前验证清单（草案）
- 手工回归：厂商注册→入驻→创建商品→管理员审核→前台查询。
- 自动化：商品、订单、支付、通知及运营指标相关集成测试需全部通过；前端 Playwright 端到端测试需在 CI 中运行。
- 性能与安全：迭代 4 起准备压测基线与 OWASP ZAP 被动扫描。

## 6. 监控与日志
- 日志：统一使用 JSON 格式，接入 ELK（开发阶段可使用 Loki + Grafana）。
- 监控指标：
  - 认证成功率、登录失败次数
  - 订单状态流转耗时
  - 支付成功率、退款成功率
  - MQ 堆积长度

