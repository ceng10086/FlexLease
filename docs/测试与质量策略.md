# 智能化共享租赁平台测试与质量策略

## 1. 测试金字塔
1. **单元测试（70%）**
   - 框架：JUnit 5 + Mockito
   - 范围：业务服务、领域逻辑、状态机。
2. **集成测试（20%）**
  - 框架：Spring Boot Test + Testcontainers（PostgreSQL、Redis、MQ）
  - 目标：验证微服务 API、数据库交互、消息事件；用户服务需模拟调用认证服务内部接口，覆盖厂商审核自动激活场景。
3. **端到端测试（10%）**
   - 前端：Playwright（或 Cypress）
   - 用户旅程：登录→下单→支付→续租/退租。

## 2. 关键测试场景
- 认证
  - 注册/登录/刷新 token 正常路径
  - 角色权限校验（未授权访问）
- 商品
  - 商品审核通过前用户不可见
  - 多租赁方案价格计算准确
  - 库存扣减/回补的一致性
- 订单
  - 正常下单→支付→发货→租赁→归还流程
  - 续租后合同日期更新
  - 超时未支付自动取消（定时任务模拟）
- 支付
  - 押金与租金分账正确
  - 支付失败回滚库存与订单状态
  - 退租后押金退款
- 厂商入驻
  - 厂商提交申请后重复提交会阻止
  - 审核通过触发认证服务 `/api/v1/internal/users/{id}/status`，账号状态由 `PENDING_REVIEW` 更新为 `ENABLED`
  - 审核失败或内部接口异常时返回友好提示，并记录错误以便排查
- 通知
  - 订单状态变更触发通知
  - 失败通知重试

## 3. 质量保障措施
- 代码规范：Checkstyle + Spotless；前端使用 ESLint + Prettier。
- 静态扫描：SonarLint（本地）+ GitHub Actions（CI）。
- CI 流程：
  1. 编译 + 单元测试
  2. 集成测试（需 Docker 环境）
  3. 前端构建与单元/E2E
- 合并策略：PR 必须通过所有流水线，至少 1 人 code review。
- 指标：
  - 单元测试覆盖率 ≥ 70%
  - 关键领域（订单、支付）分支覆盖 ≥ 80%
  - Code Smell 零容忍

## 4. 测试数据与环境
- 使用 Faker 生成测试数据。
- 集成测试环境：Docker Compose 启动 PostgreSQL、Redis、RabbitMQ。
- 测试账号：
  - Admin：`admin@example.com` / `Admin@123`
  - Vendor：`vendor@example.com` / `Vendor@123`
  - Customer：`user@example.com` / `User@123`
- 数据隔离：测试数据库 schema 使用 `*_test` 后缀，并在测试前清理。

## 5. 发布前验证清单
- 回归测试覆盖 6 个核心用户旅程。
- 性能基线：并发 100 RPS 下订单成功率 ≥ 99%，TP95 < 1.5s（本地压测）
- 安全扫描：OWASP ZAP 被动扫描，无高危漏洞。

## 6. 监控与日志
- 日志：统一使用 JSON 格式，接入 ELK（开发阶段可使用 Loki + Grafana）。
- 监控指标：
  - 认证成功率、登录失败次数
  - 订单状态流转耗时
  - 支付成功率、退款成功率
  - MQ 堆积长度

