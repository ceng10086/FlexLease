# 智能化共享租赁平台测试与质量策略

## 当前进展
- `backend/product-service` 已编写端到端集成测试 `ProductServiceIntegrationTest`，覆盖商品从草稿到上架的完整生命周期（包含库存调整）。
- 各后端模块保留 `SpringBootTest` 级别的上下文加载测试，确保基础配置可启动。
- 前端暂未配置自动化测试，依赖手动验证商品管理与审核流程。

## 1. 测试金字塔（目标）
1. **单元测试（≥60%）**：聚焦领域服务、状态流转与输入校验，优先覆盖商品与订单核心逻辑。
2. **集成测试（约30%）**：使用 Spring Boot Test + Testcontainers（PostgreSQL、Redis、消息队列）对跨组件交互进行验证，现阶段优先保障认证、厂商入驻与商品域。
3. **端到端测试（约10%）**：使用 Playwright 或 Cypress 完成核心用户旅程；迭代 2 后待补充厂商创建商品与管理员审核的回归脚本。

## 2. 关键测试场景
- **认证（已覆盖部分）**：登录成功、失败提示、`/auth/me` token 校验（待补单测）。
- **厂商入驻（已覆盖业务流程）**：提交、重复校验、审批触发认证服务内部接口（后续补集成测试）。
- **商品（已通过集成测试验证）**：商品审核前不可上架、SKU 唯一性、库存调整记录。
- **订单/支付/通知（规划中）**：迭代 3 起补充下单→支付→履约→通知链路。

## 3. 质量保障措施
- 代码规范：后端采用 Spotless/Checkstyle 计划中；目前依赖 IDE 格式化，后续将补充统一规则。前端计划引入 ESLint + Prettier。
- 静态扫描：已在 IDE 中使用 SonarLint，GitHub Actions CI 草稿待补充测试与构建步骤。
- CI 建议流程：`mvn clean verify` → `npm run build` → 自动化测试（待实现）。
- 合并策略：以迭代推进为主，要求至少 1 人 review 及通过现有测试。
- 指标目标：迭代 3 前后端核心模块单测覆盖 ≥ 60%，关键业务（订单、支付）分支覆盖 ≥ 80%。

## 4. 测试数据与环境
- 后端集成测试默认使用 H2 内存库模拟 PostgreSQL schema，后续切换至 Testcontainers 真实环境。
- 计划在 `docker-compose` 中补充 PostgreSQL、Redis、RabbitMQ，用于本地联调与测试。
- 测试账号：默认通过注册接口创建，固定账号与数据种子将在后续迁移脚本中提供。
- 数据隔离：测试使用独立 schema，Flyway 自动初始化；执行前需清理残留数据。

## 5. 发布前验证清单（草案）
- 手工回归：厂商注册→入驻→创建商品→管理员审核→前台查询。
- 自动化：商品域集成测试需全部通过；订单与支付相关测试上线后纳入。
- 性能与安全：迭代 4 起准备压测基线与 OWASP ZAP 被动扫描。

## 6. 监控与日志
- 日志：统一使用 JSON 格式，接入 ELK（开发阶段可使用 Loki + Grafana）。
- 监控指标：
  - 认证成功率、登录失败次数
  - 订单状态流转耗时
  - 支付成功率、退款成功率
  - MQ 堆积长度

