# 日志与审计（可回放）

本项目的“日志”分为三类：运行日志（stdout）、业务操作日志（业务时间线）、审计/回放日志（可用于排查与复盘）。

## 1. 运行日志（stdout）

- 各微服务/前端容器默认把日志输出到 stdout/stderr，可用 `docker compose logs -f <service>` 查看。
- 这类日志适合看异常堆栈、配置加载、启动过程；但不适合长期检索与按业务维度回放。

## 2. 业务操作日志（业务时间线）

这类日志属于“业务数据”，会直接落库，前端也会展示/查询。

- **订单时间线**：`order.order_event`
  - 记录订单状态变更、取证上传、沟通留言、纠纷阶段等事件（对应页面的 Timeline）。
- **通知发送日志**：`notification.notification_log`
  - 记录站内信/邮件/短信（模拟）等通知的发送结果与上下文（`contextType/contextRef`）。

它们更偏“业务展示与追踪”，不覆盖全量 API 请求，也不覆盖跨服务消息的收发细节。

## 3. 审计日志（HTTP 请求级）

为排查“谁在什么时间对什么接口做了什么操作、结果如何”，各微服务在处理请求后会把请求审计信息写入统一 schema：

- 表：`audit.api_audit_log`
- 写入点：`backend/platform-common/src/main/java/com/flexlease/common/audit/HttpAuditLogFilter.java`
- 核心字段：
  - `service_name`：来自 `spring.application.name`
  - `method/path/query_string/status_code/duration_ms`
  - `principal_user_id/principal_vendor_id/principal_username/roles`
  - `ip/user_agent`
  - `created_at`

常用查询示例：

```sql
-- 最近 100 条 API 审计
SELECT * FROM audit.api_audit_log ORDER BY created_at DESC LIMIT 100;

-- 查看某个用户的最近请求
SELECT * FROM audit.api_audit_log
WHERE principal_user_id = '<user-uuid>'
ORDER BY created_at DESC
LIMIT 100;

-- 过滤某个接口路径
SELECT * FROM audit.api_audit_log
WHERE path LIKE '/api/v1/orders/%'
ORDER BY created_at DESC
LIMIT 100;
```

相关配置（默认启用）：

- `flexlease.audit.enabled=true|false`
- `flexlease.audit.ignore-paths=/actuator/**,/error`（逗号分隔）

## 4. 业务回放日志（消息/事件级）

为支持“跨服务事件回放”，项目把关键消息（目前为订单领域事件）的收发写入：

- 表：`audit.business_replay_log`
- 方向：`direction=OUT|IN`
- 字段：
  - `service_name`：写入方服务名
  - `topic/routing_key/event_type`
  - `aggregate_type/aggregate_id`（当前订单事件为 `RentalOrder/<orderId>`）
  - `payload`：消息体 JSON
  - `occurred_at`：事件发生时间（若消息体带该字段）
  - `created_at`：落库时间

写入点：

- 发送侧（order-service）：`backend/order-service/src/main/java/com/flexlease/order/service/OrderEventPublisher.java`
- 消费侧（notification-service）：`backend/notification-service/src/main/java/com/flexlease/notification/service/OrderEventListener.java`

常用查询示例：

```sql
-- 最近 100 条业务回放日志
SELECT * FROM audit.business_replay_log ORDER BY created_at DESC LIMIT 100;

-- 按订单聚合查看收发
SELECT direction, service_name, event_type, occurred_at, created_at
FROM audit.business_replay_log
WHERE aggregate_id = '<order-uuid>'
ORDER BY created_at ASC;
```

## 5. 数据库迁移说明

`audit` schema 与两张表由各微服务的 Flyway 迁移创建（`V900__audit_logs.sql`）。

注意：

- Compose 默认开启 PostgreSQL volume 持久化，因此日志会“保存下来”（重启容器不丢）。
- 如果你清理了 `postgres-data` volume，相当于重置数据库，日志也会随之清空。

