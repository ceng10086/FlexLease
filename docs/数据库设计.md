# 智能化共享租赁平台数据库设计

> 假设使用 PostgreSQL 16 作为主事务库，采用命名空间（schema）划分服务数据，字段类型遵循 PostgreSQL 标准。所有时间字段使用 `TIMESTAMP WITH TIME ZONE`，金额使用 `NUMERIC(18,2)`，标识统一使用 `UUID`。

## 1. 概念模型概览
```
用户域（auth, users schema）
 ├─ user_account           用户账号与登录凭证
 ├─ user_profile           用户详细信息
 ├─ org_vendor             B 端厂商主体
 ├─ user_role / role       角色与权限

商品域（product schema）
 ├─ product                商品主表
 ├─ product_sku            SKU/租赁方案
 ├─ rental_plan            租赁模式定义（普通/先租后买/以租代售）
 ├─ inventory_snapshot     库存记录
 └─ media_asset            商品媒体资源

订单域（order schema）
 ├─ rental_order           订单主表
 ├─ rental_order_item      订单明细
 ├─ order_event            状态变更与审计
 ├─ order_extension_request 续租申请
 └─ order_return_request   退租申请

支付域（payment schema）
 ├─ payment_transaction    支付流水
 ├─ payment_split          分账明细（租金/押金/违约金）
 └─ refund_transaction     退款流水

消息与运营（notification schema）
 ├─ notification_template  通知模板
 └─ notification_log       推送记录
```

## 2. 表结构详述

### 2.1 auth schema
#### 2.1.1 `auth.user_account`
| 字段 | 类型 | 约束 | 说明 |
| ---- | ---- | ---- | ---- |
| id | UUID | PK | 账号标识 |
| username | VARCHAR(64) | UNIQUE, NOT NULL | 登录账号（手机号/邮箱/企业账号）|
| password_hash | VARCHAR(255) | NOT NULL | 密码（BCrypt）|
| status | SMALLINT | NOT NULL | 0-禁用 1-启用 2-待审核 |
| last_login_at | TIMESTAMP | NULL | 最近登录时间 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

#### 2.1.2 `auth.role`
| 字段 | 类型 | 约束 | 说明 |
| id | UUID | PK |
| code | VARCHAR(50) | UNIQUE | 角色编码（ADMIN/VENDOR/USER）|
| name | VARCHAR(50) | NOT NULL |
| description | TEXT | NULL |

#### 2.1.3 `auth.user_role`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| user_id | UUID | PK + FK -> auth.user_account |
| role_id | UUID | PK + FK -> auth.role |
| granted_at | TIMESTAMP | NOT NULL |

### 2.2 user schema
#### 2.2.1 `users.user_profile`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| user_id | UUID | UNIQUE, FK -> auth.user_account.id |
| full_name | VARCHAR(100) | NOT NULL |
| gender | SMALLINT | NULL (0-未知 1-男 2-女) |
| phone | VARCHAR(20) | NOT NULL |
| email | VARCHAR(100) | NULL |
| id_card_no | VARCHAR(32) | NULL |
| address | TEXT | NULL |
| created_at | TIMESTAMP | NOT NULL |
| updated_at | TIMESTAMP | NOT NULL |

#### 2.2.2 `users.org_vendor`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| owner_user_id | UUID | FK -> auth.user_account.id |
| company_name | VARCHAR(200) | NOT NULL |
| unified_social_code | VARCHAR(50) | UNIQUE |
| contact_name | VARCHAR(100) | NOT NULL |
| contact_phone | VARCHAR(20) | NOT NULL |
| status | SMALLINT | NOT NULL (0-待提交 1-审核中 2-已入驻 3-驳回 4-冻结) |
| remark | TEXT | NULL |
| created_at | TIMESTAMP | NOT NULL |
| updated_at | TIMESTAMP | NOT NULL |

### 2.3 product schema
#### 2.3.1 `product.product`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| vendor_id | UUID | FK -> users.org_vendor.id |
| name | VARCHAR(200) | NOT NULL |
| category_code | VARCHAR(100) | NOT NULL |
| description | TEXT | NULL |
| cover_image_url | VARCHAR(255) | NULL |
| status | VARCHAR(30) | NOT NULL (`DRAFT`/`PENDING_REVIEW`/`ACTIVE`/`INACTIVE`/`REJECTED`) |
| review_remark | TEXT | NULL |
| submitted_at | TIMESTAMP WITH TIME ZONE | NULL |
| reviewed_at | TIMESTAMP WITH TIME ZONE | NULL |
| reviewed_by | UUID | NULL |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

#### 2.3.2 `product.rental_plan`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| product_id | UUID | FK -> product.product.id |
| plan_type | VARCHAR(30) | NOT NULL (`STANDARD`/`RENT_TO_OWN`/`LEASE_TO_SALE`) |
| term_months | INT | NOT NULL |
| deposit_amount | NUMERIC(18,2) | NOT NULL |
| rent_amount_monthly | NUMERIC(18,2) | NOT NULL |
| buyout_price | NUMERIC(18,2) | NULL |
| allow_extend | BOOLEAN | DEFAULT TRUE |
| extension_unit | VARCHAR(10) | NULL |
| extension_price | NUMERIC(18,2) | NULL |
| status | VARCHAR(30) | NOT NULL (`DRAFT`/`ACTIVE`/`INACTIVE`) |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

#### 2.3.3 `product.product_sku`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| product_id | UUID | FK -> product.product.id |
| rental_plan_id | UUID | FK -> product.rental_plan.id |
| sku_code | VARCHAR(64) | UNIQUE |
| attributes | TEXT | NULL（存储 JSON 字符串） |
| stock_total | INT | NOT NULL |
| stock_available | INT | NOT NULL |
| status | VARCHAR(30) | NOT NULL (`ACTIVE`/`INACTIVE`) |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

#### 2.3.4 `product.inventory_snapshot`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | BIGSERIAL | PK |
| sku_id | UUID | FK -> product.product_sku.id |
| change_type | VARCHAR(30) | NOT NULL (`INBOUND`/`OUTBOUND`/`RESERVE`/`RELEASE`) |
| change_qty | INT | NOT NULL（正负号含义与类型相关） |
| balance_after | INT | NOT NULL |
| reference_id | UUID | NULL（订单/手工操作） |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

#### 2.3.5 `product.media_asset`（规划中）
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID | PK |
| product_id | UUID | FK |
| file_url | VARCHAR(255) | NOT NULL |
| sort_order | SMALLINT | DEFAULT 0 |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

### 2.4 order schema
> 迭代 3 中已实现下述表结构；`rental_contract` 等扩展表仍处于规划阶段。

#### 2.4.1 `order.rental_order`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| order_no | VARCHAR(40) | UNIQUE |
| user_id | UUID | FK -> auth.user_account.id |
| vendor_id | UUID | FK -> users.org_vendor.id |
| status | VARCHAR(30) | NOT NULL (`PENDING_PAYMENT`/`AWAITING_SHIPMENT`/`IN_LEASE`/`RETURN_REQUESTED`/`RETURN_IN_PROGRESS`/`COMPLETED`/`BUYOUT_REQUESTED`/`BUYOUT_COMPLETED`/`CANCELLED`) |
| plan_type | VARCHAR(30) | NULL |
| total_amount | NUMERIC(18,2) | NOT NULL |
| deposit_amount | NUMERIC(18,2) | NOT NULL |
| rent_amount | NUMERIC(18,2) | NOT NULL |
| buyout_amount | NUMERIC(18,2) | NULL |
| lease_start_at | TIMESTAMP WITH TIME ZONE | NULL |
| lease_end_at | TIMESTAMP WITH TIME ZONE | NULL |
| extension_count | INT | NOT NULL，默认 0 |
| shipping_carrier | VARCHAR(100) | NULL |
| shipping_tracking_no | VARCHAR(100) | NULL |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

#### 2.4.2 状态机描述
- `10-待支付` → 支付完成 → `20-待发货`
- `20-待发货` → 发货确认 → `30-租赁中`
- `30-租赁中`
  - 到期前续租 → `35-续租处理中`
  - 申请退租 → `40-退租中`
  - 申请买断 → `50-买断处理中`
- `40-退租中` → 商品回收+结算 → `60-已结束`
- `50-买断处理中` → 买断支付完成 → `70-已买断`
- 异常：`90-已取消`，`99-异常关闭`

#### 2.4.3 `order.rental_order_item`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| order_id | UUID | FK -> order.rental_order.id |
| product_id | UUID | NOT NULL |
| sku_id | UUID | NULL |
| plan_id | UUID | NULL |
| product_name | VARCHAR(200) | NOT NULL |
| sku_code | VARCHAR(64) | NULL |
| plan_snapshot | VARCHAR(255) | NULL（存储序列化后的方案摘要） |
| quantity | INT | NOT NULL |
| unit_rent_amount | NUMERIC(18,2) | NOT NULL |
| unit_deposit_amount | NUMERIC(18,2) | NOT NULL |
| buyout_price | NUMERIC(18,2) | NULL |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

#### 2.4.4 `order.order_event`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| order_id | UUID | FK -> order.rental_order.id |
| event_type | VARCHAR(50) | NOT NULL |
| description | TEXT | NULL |
| created_by | UUID | NULL |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

#### 2.4.5 `order.order_extension_request`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| order_id | UUID | FK -> order.rental_order.id |
| status | VARCHAR(30) | NOT NULL (`PENDING`/`APPROVED`/`REJECTED`) |
| additional_months | INT | NOT NULL |
| requested_by | UUID | NOT NULL |
| requested_at | TIMESTAMP WITH TIME ZONE | NOT NULL |
| decision_by | UUID | NULL |
| decision_at | TIMESTAMP WITH TIME ZONE | NULL |
| remark | TEXT | NULL |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

#### 2.4.6 `order.order_return_request`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| order_id | UUID | FK -> order.rental_order.id |
| status | VARCHAR(30) | NOT NULL (`PENDING`/`APPROVED`/`REJECTED`) |
| reason | TEXT | NULL |
| logistics_company | VARCHAR(100) | NULL |
| tracking_number | VARCHAR(100) | NULL |
| requested_by | UUID | NOT NULL |
| requested_at | TIMESTAMP WITH TIME ZONE | NOT NULL |
| decision_by | UUID | NULL |
| decision_at | TIMESTAMP WITH TIME ZONE | NULL |
| remark | TEXT | NULL |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL |

> `order.rental_contract`、`order.return_request`（换货）等表保持在 Backlog，待后续迭代扩展。

### 2.5 payment schema
#### 2.5.1 `payment.payment_transaction`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| order_id | UUID | FK |
| transaction_no | VARCHAR(60) | UNIQUE |
| payment_scene | SMALLINT | NOT NULL (1-押金 2-租金 3-买断 4-违约金) |
| amount | NUMERIC(18,2) | NOT NULL |
| status | SMALLINT | NOT NULL (0-待支付 1-成功 2-失败) |
| channel | VARCHAR(30) | NOT NULL (MOCK/ALIPAY/WECHAT/BANK) |
| paid_at | TIMESTAMP | NULL |
| created_at | TIMESTAMP | NOT NULL |
| updated_at | TIMESTAMP | NOT NULL |

#### 2.5.2 `payment.payment_split`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| transaction_id | UUID | FK -> payment_transaction.id |
| split_type | SMALLINT | NOT NULL (1-平台佣金 2-厂商所得 3-押金) |
| amount | NUMERIC(18,2) | NOT NULL |
| beneficiary | VARCHAR(100) | NOT NULL |
| created_at | TIMESTAMP | NOT NULL |

#### 2.5.3 `payment.refund_transaction`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| payment_transaction_id | UUID | FK |
| refund_no | VARCHAR(60) | UNIQUE |
| amount | NUMERIC(18,2) | NOT NULL |
| reason | VARCHAR(200) | NULL |
| status | SMALLINT | NOT NULL (0-处理中 1-成功 2-失败) |
| refunded_at | TIMESTAMP | NULL |
| created_at | TIMESTAMP | NOT NULL |

### 2.6 notification schema
#### 2.6.1 `notification.notification_template`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| code | VARCHAR(50) | UNIQUE |
| channel | SMALLINT | NOT NULL (1-邮件 2-短信 3-站内信) |
| subject | VARCHAR(200) | NOT NULL |
| content | TEXT | NOT NULL |
| created_at | TIMESTAMP | NOT NULL |

#### 2.6.2 `notification.notification_log`
| 字段 | 类型 | 约束 |
| ---- | ---- | ---- |
| id | UUID | PK |
| template_code | VARCHAR(50) | NOT NULL |
| recipient | VARCHAR(100) | NOT NULL |
| payload | JSONB | NULL |
| status | SMALLINT | NOT NULL (0-待发送 1-成功 2-失败) |
| sent_at | TIMESTAMP | NULL |
| created_at | TIMESTAMP | NOT NULL |

## 3. 索引策略
- `user_account.username`、`user_profile.phone`：唯一索引以支持登录与账户查找。
- `product.product (vendor_id, status)`：联合索引便于厂商商品列表。
- `product.product_sku (sku_code)`：唯一索引保障 SKU 唯一。
- `order.rental_order (user_id, created_at)`、`(vendor_id, status)`：筛选用户/厂商订单。
- `payment.payment_transaction (order_id, payment_scene)`：订单支付场景查询。
- `notification.notification_log (status, created_at)`：轮询或批处理。

## 4. 数据一致性策略
- **库存预占**：`stock_available` 与订单状态结合，采用本地事务+悲观锁或 Redis 分布式锁；失败时回滚并记录 `inventory_snapshot`。
- **订单支付**：支付成功后使用事件表或消息队列驱动订单状态更新；失败时回滚并通知用户。
- **租赁续期**：合同表 `lease_end_at` 结合定时任务提前触发续租提醒；延长后更新 `extend_count` 与 `lease_end_at`。
- **押金退还**：流程完成时写入 `refund_transaction`，以事件驱动触发支付服务退款逻辑。

## 5. 审计与日志
- 所有关键表（订单、支付、库存）保持 `created_by`、`updated_by` 字段，可在后续编码阶段添加。
- 重要操作（订单状态变更、支付动作）写入 `order_event_log`/`payment_event_log`。

## 6. 数据迁移与脚本
- 使用 Flyway 或 Liquibase 管理 schema 版本，根目录维护 `db/migration/<service>`。
- 初始数据：角色、权限、通知模板、租赁模式枚举等写入迁移脚本。

## 7. 扩展与优化建议
- 大数据量场景可将 `notification_log`、`order_event_log` 拆分冷数据表或归档。
- 如需支持多货币，多增加 `currency_code` 字段并考虑汇率表。
- 订单状态日志可结合 Elasticsearch 提升检索体验。
