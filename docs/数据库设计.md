# 智能化共享租赁平台数据库设计

> 平台使用 PostgreSQL 16，按照微服务划分 schema（`auth`、`users`、`product`、`order`、`payment`、`notification`）。所有业务主键统一为 `UUID`，金额使用 `NUMERIC(18,2)`，时间统一存储为 `TIMESTAMP WITH TIME ZONE`，并通过 Flyway 在各服务内管理迁移。

## 1. Schema 概览

- **auth**：账号、角色与账号角色关联，负责登录状态与厂商 ID 绑定。
- **users**：用户资料、厂商主体与厂商入驻申请。
- **product**：商品、租赁方案、SKU/库存流水以及媒体资源。
- **order**：订单主表、明细、操作事件、续租/退租申请、电子合同与购物车。
- **payment**：支付流水、分账记录、退款流水与结算统计依赖。
- **notification**：通知模板与发送日志，供站内信/邮件模拟使用。

## 2. 表结构详述

### 2.1 `auth` schema

#### `auth.user_account`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK | 账号 ID |
| username | VARCHAR(64), UNIQUE | 登录名（邮箱/手机号） |
| password_hash | VARCHAR(255) | BCrypt 密文 |
| status | VARCHAR(20) | `ENABLED`/`DISABLED`/`PENDING_REVIEW` |
| vendor_id | UUID | 绑定的厂商 ID（厂商账号审批通过后写入） |
| last_login_at | TIMESTAMP WITH TIME ZONE | 最近登录时间 |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE | 审计字段 |

索引：`idx_user_account_username`、`idx_user_account_vendor`。

#### `auth.role`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK | 角色 ID |
| code | VARCHAR(50), UNIQUE | `ADMIN`/`VENDOR`/`USER` |
| name | VARCHAR(50) | 展示名称 |
| description | TEXT | 描述 |

#### `auth.user_role`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| user_id | UUID, PK, FK -> user_account.id | 账号 ID |
| role_id | UUID, PK, FK -> role.id | 角色 ID |
| granted_at | TIMESTAMP WITH TIME ZONE | 授权时间 |

### 2.2 `users` schema

#### `users.user_profile`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| user_id | UUID, UNIQUE | 对应 `auth.user_account.id` |
| full_name | VARCHAR(100) | 真实姓名 |
| gender | VARCHAR(10) | `UNKNOWN`/`MALE`/`FEMALE` |
| phone | VARCHAR(20) | 联系电话 |
| email | VARCHAR(100) | 邮箱 |
| address | VARCHAR(255) | 地址 |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE | 审计字段 |

#### `users.vendor`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK | 厂商 ID |
| owner_user_id | UUID | 初始负责人账号 |
| company_name | VARCHAR(200) | 公司名称 |
| contact_name | VARCHAR(100) | 联系人 |
| contact_phone | VARCHAR(50) | 联系电话 |
| contact_email | VARCHAR(100) | 邮箱 |
| province / city / address | VARCHAR | 地址信息 |
| status | VARCHAR(30) | `ACTIVE`/`SUSPENDED` |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE | 审计字段 |

索引：`idx_vendor_owner`、`idx_vendor_status`。

#### `users.vendor_application`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| owner_user_id | UUID | 申请账号 |
| company_name | VARCHAR(200) | 公司名称 |
| unified_social_code | VARCHAR(50), UNIQUE | 统一社会信用代码 |
| contact_name / contact_phone / contact_email | VARCHAR | 联系信息 |
| province / city / address | VARCHAR | 地址 |
| status | VARCHAR(30) | `DRAFT`/`SUBMITTED`/`APPROVED`/`REJECTED`/`SUSPENDED` |
| submitted_at | TIMESTAMP WITH TIME ZONE | 最近提交时间 |
| reviewed_by | UUID | 审核管理员 |
| reviewed_at | TIMESTAMP WITH TIME ZONE | 审核时间 |
| review_remark | VARCHAR(255) | 审核备注 |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE | 审计字段 |

索引：`idx_vendor_application_status`、`idx_vendor_application_owner`。

### 2.3 `product` schema

#### `product.product`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| vendor_id | UUID | 所属厂商 |
| name | VARCHAR(200) | 商品名称 |
| category_code | VARCHAR(100) | 类目编码 |
| description | TEXT | 描述 |
| cover_image_url | VARCHAR(255) | 封面图 |
| status | VARCHAR(30) | `DRAFT`/`PENDING_REVIEW`/`ACTIVE`/`INACTIVE`/`REJECTED` |
| review_remark | TEXT | 审核意见 |
| submitted_at / reviewed_at | TIMESTAMP WITH TIME ZONE | 审核节点 |
| reviewed_by | UUID | 审核人 |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE | 审计字段 |

索引：`idx_product_vendor`、`idx_product_status`。

#### `product.rental_plan`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| product_id | UUID, FK -> product.id |
| plan_type | VARCHAR(30) | `STANDARD`/`RENT_TO_OWN`/`LEASE_TO_SALE` |
| term_months | INT | 租期 |
| deposit_amount | NUMERIC(18,2) | 押金 |
| rent_amount_monthly | NUMERIC(18,2) | 月租 |
| buyout_price | NUMERIC(18,2) | 买断价 |
| allow_extend | BOOLEAN | 是否可续租 |
| extension_unit | VARCHAR(10) | 续租单位（月/周） |
| extension_price | NUMERIC(18,2) | 续租价格 |
| status | VARCHAR(30) | `DRAFT`/`ACTIVE`/`INACTIVE` |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE |

索引：`idx_rental_plan_product`。

#### `product.product_sku`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| product_id | UUID |
| rental_plan_id | UUID | 所属方案，可为空 |
| sku_code | VARCHAR(64), UNIQUE |
| attributes | TEXT | JSON 字符串 |
| stock_total / stock_available | INT | 总库存/可用库存 |
| status | VARCHAR(30) | `ACTIVE`/`INACTIVE` |
| version | BIGINT | JPA 乐观锁版本号，支撑高并发库存扣减重试 |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE |

索引：`idx_product_sku_plan`。

#### `product.inventory_snapshot`
记录每次库存变更。

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | BIGSERIAL, PK |
| sku_id | UUID |
| change_type | VARCHAR(30) | `INBOUND`/`OUTBOUND`/`RESERVE`/`RELEASE` |
| change_qty | INT | 数量（正负值由 `change_type` 决定） |
| balance_after | INT | 更新后的库存 |
| reference_id | UUID | 关联的订单/请求 |
| created_at | TIMESTAMP WITH TIME ZONE |

索引：`idx_inventory_snapshot_sku`。

#### `product.media_asset`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| product_id | UUID |
| file_name | VARCHAR(255) | 原始文件名 |
| file_url | VARCHAR(255) | 静态资源路径 |
| content_type | VARCHAR(100) | MIME 类型 |
| file_size | BIGINT | 字节数 |
| sort_order | INT | 排序 |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE |

索引：`idx_media_asset_product`。

### 2.4 `order` schema

#### `order.rental_order`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| order_no | VARCHAR(40), UNIQUE | 订单号 |
| user_id | UUID | 消费者 |
| vendor_id | UUID | 厂商 |
| status | VARCHAR(30) | `PENDING_PAYMENT`/`AWAITING_SHIPMENT`/`IN_LEASE`/`RETURN_REQUESTED`/`RETURN_IN_PROGRESS`/`COMPLETED`/`BUYOUT_REQUESTED`/`BUYOUT_COMPLETED`/`CANCELLED`/`EXCEPTION_CLOSED` |
| plan_type | VARCHAR(30) | 订单租赁模式 |
| total_amount / deposit_amount / rent_amount / buyout_amount | NUMERIC(18,2) | 金额合计 |
| payment_transaction_id | UUID | 对应的支付流水 |
| lease_start_at / lease_end_at | TIMESTAMP WITH TIME ZONE | 租期 |
| extension_count | INT | 续租次数 |
| shipping_carrier / shipping_tracking_no | VARCHAR(100) | 物流信息 |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE |

索引：`idx_rental_order_user`、`idx_rental_order_vendor`、`idx_rental_order_status`。

#### `order.rental_order_item`
固化下单时的商品信息（包含 `plan_snapshot` JSON）。

#### `order.order_event`
记录状态变更历史，字段：`id`、`order_id`、`event_type`（见 `OrderEventType` 枚举）、`description`、`created_by`、`created_at`。

#### `order.order_extension_request` / `order.order_return_request`
存储续租与退租申请，包含 `status`、`requested_by`、`decision_by`、`remark` 等字段，便于追踪审批链路。

#### `order.rental_contract`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| order_id | UUID, UNIQUE |
| contract_number | VARCHAR(50) | 合同编号 |
| content | TEXT | 合同内容 |
| status | VARCHAR(20) | `DRAFT`/`SIGNED` |
| signature | VARCHAR(255) | 手写签名快照 |
| signed_by | UUID | 签署用户 |
| generated_at / signed_at / created_at / updated_at | TIMESTAMP WITH TIME ZONE |

#### `order.cart_item`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| user_id / vendor_id / product_id / sku_id | UUID |
| plan_id | UUID | 方案 ID |
| product_name / sku_code | VARCHAR |
| plan_snapshot | TEXT | 定价快照 JSON |
| quantity | INT |
| unit_rent_amount / unit_deposit_amount / buyout_price | NUMERIC(18,2) |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE |

索引：`idx_cart_item_user`、`idx_cart_item_user_sku`。

### 2.5 `payment` schema

#### `payment.payment_transaction`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| order_id | UUID |
| user_id / vendor_id | UUID |
| transaction_no | VARCHAR(60), UNIQUE | 流水号 |
| scene | VARCHAR(20) | `DEPOSIT`/`RENT`/`BUYOUT`/`PENALTY` |
| status | VARCHAR(20) | `PENDING`/`SUCCEEDED`/`FAILED` |
| channel | VARCHAR(30) | `MOCK`/`ALIPAY`/`WECHAT`/`BANK_TRANSFER` |
| amount | NUMERIC(18,2) | 支付总额 |
| description | TEXT |
| channel_transaction_no | VARCHAR(100) |
| paid_at | TIMESTAMP WITH TIME ZONE |
| created_at / updated_at | TIMESTAMP WITH TIME ZONE |

索引：`idx_payment_tx_order_scene`、`idx_payment_tx_vendor_status`、`idx_payment_tx_paid_at`。

#### `payment.payment_split`
记录分账结果。

| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| transaction_id | UUID |
| split_type | VARCHAR(30) | `PLATFORM_COMMISSION`/`VENDOR_INCOME`/`DEPOSIT_RESERVE` |
| amount | NUMERIC(18,2) |
| beneficiary | VARCHAR(100) |
| created_at | TIMESTAMP WITH TIME ZONE |

#### `payment.refund_transaction`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| transaction_id | UUID |
| refund_no | VARCHAR(60), UNIQUE |
| amount | NUMERIC(18,2) |
| reason | VARCHAR(200) |
| status | VARCHAR(20) | `PROCESSING`/`SUCCEEDED`/`FAILED` |
| refunded_at / created_at / updated_at | TIMESTAMP WITH TIME ZONE |

### 2.6 `notification` schema

#### `notification.notification_template`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| code | VARCHAR(50), UNIQUE |
| channel | VARCHAR(20) | `EMAIL`/`SMS`/`IN_APP` |
| subject | VARCHAR(200) |
| content | TEXT |
| created_at | TIMESTAMP WITH TIME ZONE |

#### `notification.notification_log`
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| id | UUID, PK |
| template_code | VARCHAR(50) |
| channel | VARCHAR(20) |
| recipient | VARCHAR(100) | 用户或厂商 ID |
| subject / content | TEXT |
| payload | TEXT | 模板变量快照 |
| status | VARCHAR(20) | `PENDING`/`SENT`/`FAILED` |
| error_message | TEXT |
| sent_at / created_at | TIMESTAMP WITH TIME ZONE |

索引：`idx_notification_log_status_created_at`、`idx_notification_log_recipient`。

## 3. 索引与约束

- 所有主表均以 UUID 为 PK，并在外键列上添加 `ON DELETE CASCADE`（如 `order` 系列）以维持引用一致性。
- 关键查询字段建立索引：如 `order.rental_order (user_id, created_at)`、`payment.payment_transaction (vendor_id, status)`、`users.vendor_application (status)` 等。
- 业务唯一约束：`product.product.sku_code`、`users.vendor_application.unified_social_code`、`auth.user_account.username`、`order.rental_contract.order_id` 等。

## 4. 数据一致性与流程

- **库存管理**：订单创建前通过 `InventoryReservationClient` 调用 `product-service` `/internal/inventory/reservations` 接口批量预占库存（`changeType=RESERVE`），发货时执行 `OUTBOUND` 并补充 `RELEASE`，退租完成则调用 `INBOUND` 恢复库存，如发生异常会在 `RentalOrderService` 中回滚补偿。
- `product_sku.version` 字段结合应用层重试（`flexlease.inventory.concurrency.*`）可在高并发下通过乐观锁保障库存一致性，并将写冲突转化为快速重试。
- **支付闭环**：`payment-service` 创建流水后会根据 `flexlease.payment.auto-confirm` 自动完成或等待管理员手工确认，成功后再通过 `/api/v1/internal/orders/{id}/payment-success` 反查订单、写入 `payment_transaction_id` 并驱动状态机；退租/押金返还由订单服务读取支付流水并使用 `PaymentClient.createRefund` 触发内部退款。
- **待支付超时**：`OrderMaintenanceScheduler` 每隔 `flexlease.order.maintenance.scan-interval-ms` 扫描超过 `pending-payment-expire-minutes` 的订单，将其置为 `CANCELLED` 并释放库存、推送通知与 RabbitMQ 事件。
- **合同与事件审计**：`OrderContractService` 访问 `order.rental_contract` 保持订单与合同内容同步，`OrderEventPublisher` 把 `order_event` 中的记录序列化后投递到 `order.events` 交换机供 `notification-service` 使用。
- **通知可见性**：`notification-service` 根据 JWT 角色把 `notification_log` 查询范围限定为当前 `userId` 或 `vendorId`，管理员可查看全局但默认只返回最近 50 条。
- **购物车约束**：`CartService` 只允许访问自身 `userId` 的条目，下单引用多个 `cartItemIds` 时会验证所有条目属于同一 `vendor_id` 并在成功后清空。

## 5. 审计与监控

- `order.order_event`、`payment.refund_transaction` 作为关键操作日志，前端在订单/支付详情中直接读取。
- `notification.notification_log` 存储发送结果，可结合 Redis 缓存的模板定位通知异常。
- 所有表均包含 `created_at/updated_at`（或 `granted_at` 等）字段，方便以时间维度排查问题。

## 6. 迁移与初始化

- 每个服务在 `backend/<service>/src/main/resources/db/migration` 维护自身 schema 的 Flyway 脚本；仓库根目录 `db/migration/<schema>` 仅保留统一建库示例。
- `./mvnw clean verify` 默认在 H2 + Flyway 下执行，生产/Compose 环境通过 PostgreSQL 完整复现结构；认证服务的 `DataInitializer` 会自动写入角色及管理员账号。

## 7. 扩展建议

- 根据业务量可将 `notification_log`、`order_event` 拆分冷热数据或引入归档队列。
- 如果需要真实支付通道，可扩展 `payment-channel` 与回调验签逻辑，或在 `payment_split` 中增加更多受益人类型。
- 目前库存由 `product-service` 行内锁保证，若需要高并发可在 `inventory_snapshot` 基础上引入乐观锁/Redis 分布式锁。
