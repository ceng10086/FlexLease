# FlexLease 用户故事地图（信用与协作增强）

面向 `README.md`、`docs/` 全量文档以及当前代码（如 `backend/order-service`、`notification-service`、`frontend/src/pages/**`）梳理，先覆盖平台完整旅程（账号入驻→商品准备→消费下单→履约售后→结算分析），再针对以下五个主题叠加策略：

1. 个人信用：加/减分动作与阈值触发的平台处理。
2. 沟通：厂商与用户在各履约阶段的沟通方式与平台支撑。
3. 平台抽成：调研后的合理区间与适配策略。
4. 履约证明：发货、收货、退还等环节的取证需求。
5. 矛盾处理：预设方案与升级通道。

## 1. 角色画像

| 角色 | 目标 | 痛点 | 关键系统映射 |
| --- | --- | --- | --- |
| 平台管理员（风控/运营） | 控制信用风险、平衡抽成、快速裁决纠纷 | 缺少联动视图与标准化处罚，调解耗时 | `auth-service` 角色、`order-service` 管理接口、`notification-service` |
| 厂商（B 端） | 提升履约效率、降低纠纷成本、获得合理结算 | 沟通工具分散、无法证明出货状态、抽成不透明 | `vendor` 工作台、`product-service` 媒体、`payments/settlements` |
| 消费者（C 端） | 可信租赁体验、透明押金/信用政策、便捷沟通 | 不清楚信用规则、纠纷无从申诉、证明资料难保存 | `customer` 端下单、`orders/{id}` 时间线、`notifications` |

## 2. 用户故事地图（按旅程阶段）

| 阶段 | 核心活动（Backbone） | 管理员故事 | 厂商故事 | 消费者故事 |
| --- | --- | --- | --- | --- |
| A. 账号与入驻 | 角色注册、厂商资质审核、消费者建档 | 通过 `auth-service`/`user-service` 审核厂商申请、启用账号；配置菜单/权限 | 注册、提交入驻资料，跟踪审核状态 | 完成注册、完善个人资料（自动建立 `customers/profile`；实名认证为预留/内部事件模拟） |
| B. 商品筹备 | 厂商配置商品/方案/SKU，管理员审核 | 处理 `/admin/products` 审核、控制类目政策 | 使用 `frontend/src/views/vendor/workbench/ProductBoardView.vue` 维护商品、库存、媒体，提交审核 | 在 Catalog 中可见审核通过的商品 |
| C. 商品发现与试算 | Catalog 搜索、详情、购物车、订单预览 | 配置推荐位、监控曝光与 GMV；处理营销公告 | 关注商品曝光、库存与咨询；准备运营文案 | 浏览 `/app/catalog`、加入购物车、调用 `/orders/preview` 试算 |
| D. 下单与支付 | 创建订单、合并购物车、支付/退款 | `frontend/src/views/admin/AdminOrderMonitorView.vue` 查看订单流、触发强制关闭；检查支付风控 | 根据通知及时处理订单、补齐合同条款 | 在 `frontend/src/views/checkout/CheckoutShell.vue` 下单并通过 `payment-service` 自动/手动完成支付 |
| E. 履约与售后 | 发货、收货、续租、退租、买断 | 监控履约 SLA、审核异常订单、处理投诉 | 在 `frontend/src/views/vendor/workbench/FulfillmentDetailSheet.vue` 操作发货/审批，并管理库存补偿 | 在 `frontend/src/views/orders/detail/OrderDetailShell.vue` 查看物流、上传取证、发起续租/退租/买断 |
| F. 结算与运营 | 结算对账、抽成、通知/看板、满意度 | 查看 `/analytics/dashboard`、`/payments/settlements`、通知模板；复盘纠纷 | 读取结算拆分、运营指标、通知；按需求申诉 | 查看合同/信用、通知历史，完成评价 |

## 3. 主题旅程（聚焦信用/沟通/抽成/证明/矛盾）

在整体旅程骨干上，进一步从五个主题视角观察各阶段的细化故事：

| 阶段 | 核心活动（Backbone） | 管理员故事 | 厂商故事 | 消费者故事 |
| --- | --- | --- | --- | --- |
| A. 注册与信用沉淀 | 绑定身份、初始信用授予、查看信用规则 | 维护信用模型与阈值；监控异常账号；通过 `user-service` 批量调级 | 在工作台看到平台信用要求与奖励；提交额外资质以争取更低抽成 | 查看个人信用评分与影响项；实名认证为预留/内部事件模拟（当前不影响“初始押金比例”） |
| B. 下单与确认 | 试算、提交订单、自动支付、首轮通知 | 根据信用分判断是否需要人工复核或提升押金比例；触发信用减分预警 | 设定接单 SLA、收到系统通知并在订单时间线回复 | 使用订单创建页看到信用对押金的影响；收到下单确认与沟通入口 |
| C. 履约与证明 | 发货、收货、租赁中巡检、退租/续租申请 | 审核样本订单的取证资料；抽检证明合规性 | 上传发货照片/视频并绑定防拆封条；在时间线中留存巡检证据；使用模板快速回复续租/退租 | 收货前查看发货证据；收货/退租时按指引上传多媒体证明并选择沟通方式 |
| D. 结算与抽成 | 结算核对、佣金计算、信用联动 | 设置行业/信用分的阶梯抽成；在 `payments/settlements` 导出对账 | 查看实时抽成比例及依据；申请季度评估以争取调档 | 在账单与合同中看到平台抽成影响（例如平台服务费、押金减免） |
| E. 冲突与调解 | 触发预设处理、记录仲裁、结案复盘 | 在纠纷面板查看各方提供的证据链；根据模板（重发、折扣、退押金）裁决 | 在订单详情里选择预设解决方案并上传补充证明；必要时请求平台介入 | 通过内置沟通渠道提交诉求，选择预设方案或升级至平台；查看信用扣分与可申诉条目 |
| F. 复盘与成长 | 信用变更、沟通回顾、满意度调研 | 运营看板新增信用分布、纠纷类型；触发通知模板鼓励良好行为，并可通过 `scripts/dashboard-report.mjs` 导出周报 | 收到信用加分提醒；参考纠纷复盘改进流程 | 在通知中心看到信用积分明细、申诉入口与成功经验 |

> 每个阶段均复用现有 `order_event` 时间线与 `notification-service`，新增的故事会在后续章节映射到具体服务。

## 4. 主题策略详解

### 4.1 个人信用与分值策略

| 行为 | 加/减分 | 数据来源 | 平台自动处理 |
| --- | --- | --- | --- |
| 完成实名认证（预留/内部事件模拟） | +10 | `user-service` `/api/v1/internal/users/{id}/credit-events` | 仅影响信用分与信用档位（达到 `EXCELLENT` 后押金系数才会触发减免） |
| 准时支付订单、无逾期 | +5 每单 | `payment-service` 成功回执 | 连续 3 单后触发 `notification-service` 奖励提醒 |
| 提前/按约归还（到期前或 24 小时宽限内） | +8 | `order-service` 履约完成事件 | 推送信用加分站内信（信用分本身会影响后续押金系数与是否需要人工审核） |
| 待支付超时被系统取消 | -8 | `order-service` `OrderMaintenanceScheduler` | 信用扣分并推送提醒；若信用降至 `WARNING` 则后续押金系数上浮为 1.20 |
| 恶意拒收、拒不退还、经判定需赔偿 | -30 | 平台裁决记录 | 自动冻结下单权限 30 天，并通知管理员跟进 |
| 友好沟通解决纠纷 | +3 | 纠纷模块与时间线 | 写入信用事件并推送通知（用于改善信用档位） |
| 管理员人工调整 | ±N | `/api/v1/admin/users/{id}/credit-adjustments` | 记录原因、下发通知；支持管理员查询历史调整记录用于审计 |

**阈值及动作**

- `>=90`（`EXCELLENT`）：押金系数 `0.70`（减免 30%）；`payment-service` 结算时会基于订单信用快照把平台抽成再减 `0.01`（最低为 `0`）。
- `60~89`（`STANDARD`）：押金系数 `1.00`。
- `40~59`（`WARNING`）：押金系数 `1.20` 且 `requiresManualReview=true`（不阻断支付/履约），管理员可在 `frontend/src/views/admin/AdminOrderMonitorView.vue` 中筛选。
- `<40`（`RESTRICTED`）：拒绝创建新订单（服务端返回 `403`）。

信用快照会写入：
1. `users.user_profile` 新增 `credit_score` 与 `credit_tier`。
2. `order.rental_order` 保留下单时的信用分，便于结算回溯。
3. `frontend` 在 `/app/checkout`、`/app/orders/:orderId/*`、`/app/dashboard` 提示信用影响。

### 4.2 沟通渠道（按流程拆解）

| 流程阶段 | 沟通触点 | 平台提供的能力 |
| --- | --- | --- |
| 下单前（试算/询价） | 商品详情页内的“咨询”入口、`notification-service` 站内信模板 | 咨询需登录后提交，默认 72 小时有效；厂商可在工作台集中查看/回复，过期后自动标记为 `EXPIRED` 并拒绝响应 |
| 下单 & 支付 | 订单创建自动写入 `order_event`，双向通知 | 调整 `NotificationTemplate`，附上聊天入口链接、信用提示；管理员可在后台插入公告 |
| 发货 & 收货 | 物流填写页面 + 证据上传 | 在 `frontend/src/views/vendor/workbench/FulfillmentDetailSheet.vue` 的发货抽屉中新增“留言给用户”字段；用户确认收货前需阅览证据并可留言 |
| 租赁中 & 售后 | 续租/退租/买断流程 | 在 `frontend/src/views/orders/detail/OrderDetailShell.vue` 中拆分嵌入“会话/凭证/时间线”组件，展示申请状态、可选预设回复（见 4.5）；系统自动在超时节点推送提醒 |
| 退租 & 取证 | 退租申请表单 + 取证清单 | 表单自动拉取需要拍摄的角度、视频要求，提交后写入 `order_proof` |
| 纠纷升级 | 纠纷抽屉 + 平台裁决 | 仲裁管理人员在仲裁中心/纠纷抽屉中完成裁决；纠纷请求支持 `phoneMemo` 记录电话沟通要点 |

### 4.3 平台抽成策略（调研结论）

调研国内 B2C 租赁平台（以京东企业租赁、爱租机的公开招商资料为参照）后，抽成区间多在 **5%~12%** 之间，3C 产品处于区间上限、家电和家居用品较低。

| 商品类型 | 推荐抽成 | 调整因子 | 平台说明 |
| --- | --- | --- | --- |
| 3C/智能设备 | 10%（优选 8~12%） | 厂商信用、履约 SLA、平台活动资源占用 | 信用优享厂商（信用>=90 且 3 个月无纠纷）可下调 2% |
| 家电/家居 | 6%（5~8%） | 物流由平台承担时 +1%；大件安装由厂商承担时 -1% | 在 `payments/settlements` 显示拆分细目 |
| 短租体验、饰品 | 8% 固定 | 单笔额低、履约频次高，需要更多平台客服 | 提供批量结算模板 |

抽成策略实现：
- `payment-service` 增加 `commission_rate` 字段，计算 `PLATFORM_COMMISSION` 拆分。
- `user-service` 为厂商配置 `commission_profile`（行业 + 信用档 + 指标）。
- `order-service` 对外公开 `/api/v1/internal/vendors/{id}/performance-metrics`，基于发货准时率/纠纷解决率/取消率生成 SLA 评分供抽成调节。
- `frontend` 的结算页面展示平台分成、厂商实收、信用折扣。

### 4.4 履约证明（取证清单）

| 节点 | 证明要求 | 存储设计 | 用户故事 |
| --- | --- | --- | --- |
| 厂商发货 | 3 张照片（外观、序列号、包装）+ 1 段视频（时长/清晰度为建议，后端当前只校验数量） | `order-service` 接收 `/orders/{orderId}/proofs` 上传：元数据写入 `order.order_proof`，文件落在 `flexlease.proof-storage.root`（本地默认 `storage/order-proofs`；Compose 默认 `/app/storage/order-proofs`） | 厂商在发货抽屉中上传证明，系统按 `contentType/后缀` 识别图片/视频并统计数量，图片会尽力打上“订单号+时间”的水印；上传完成后再允许提交运单 |
| 用户收货 | 开箱视频（含包装完好），签字照片 | 同上（由 `order-service` 统一存储，并标记 `PROOF_TYPE=RECEIVE`） | 用户必须上传后才能点击“确认收货”，且照片自动水印订单号 + 上传时间 |
| 租赁中巡检（可选） | 设备使用状态照片、故障日志 | `order_event` 追加 `INSPECTION_REQUESTED/INSPECTION_REWARDED`；取证类型 `INSPECTION` | 厂商可在履约抽屉发起巡检请求（`/orders/{id}/inspection/request`），用户上传巡检凭证后自动获得 +2 信用并写入时间线 |
| 退租寄出 | 包裹称重照片、快递面单、视频 | 同上 | 用户提交后自动触发厂商和管理员通知 |
| 厂商验收入库 | 厂家检测单、损坏照片 | 与库存 `inventory_snapshot` 关联 | 验收失败则在纠纷模块中转入仲裁 |

### 4.5 矛盾处理与升级

1. **预设选项**（在 `frontend/src/views/orders/detail/OrderTimelineView.vue` 的纠纷区域中展示）：
   - `A`：重新发货 / 零件补发
   - `B`：部分退款 + 继续租赁
   - `C`：退租并扣减押金
   - `D`：买断优惠
2. **流程**：
   1. 一方发起纠纷 → 自动创建 `order_dispute`（新表）记录，生成 48 小时倒计时。
   2. 双方选择预设方案或上传自定义诉求，系统提示信用影响。
   3. 若 48 小时无共识，管理员介入：读取所有 `order_proof`+`order_event`，可添加调解建议。
   4. 仲裁管理人员裁决 → 自动更新信用分与押金处理，触发 `notification-service` 模板，若任一方不服，可提交二次申诉（限制一次），由平台复核组处理。
3. **沟通渠道**：
   - 在纠纷抽屉内提供 `文本 + 图片 + 视频` 上传、电话纪要录入（现已在消费者/厂商/管理员工作台中落地，可直接查看并下载附件）。
   - `notification-service` 新增模板 `DISPUTE_COUNTDOWN`、`DISPUTE_RESOLVED`。
4. **复盘**：纠纷结束后 24 小时推送满意度调查；管理员仪表盘新增纠纷漏斗与平均处理时长。

## 5. 数据与技术映射

- **数据库**：`users.user_profile`、`order.rental_order`、`order_event`、`order_proof`（新）、`order_dispute`（新）、`payment.payment_transaction` 扩展字段。
- **服务改造**：
  - `order-service`：扩充 `OrderEventType`、`RentalOrderResponse`；提供信用联动字段、预设沟通 API。
  - `notification-service`：新增模板 + 频道过滤 + 倒计时提醒。
  - `frontend`：`frontend/src/views/dashboard/DashboardHome.vue` 展示信用分布；`frontend/src/views/vendor/workbench/FulfillmentDetailSheet.vue`、`frontend/src/views/orders/detail/OrderDetailShell.vue`、`frontend/src/views/notifications/NotificationCenterView.vue` 嵌入信用提示和沟通组件。
- **接口契约**：`/analytics/dashboard` 增加信用与纠纷统计；`/analytics/vendor/{id}` 展示厂商信用加权抽成；`/notifications/logs` 支持按 `contextType=DISPUTE` 过滤。

> 以上故事地图旨在保持 FlexLease 现有微服务边界不变，通过新增字段与轻量服务扩展实现 KISS 原则下的信用、沟通、抽成与纠纷闭环。部署层面复用现有 Docker Compose，无需新增中间件。
