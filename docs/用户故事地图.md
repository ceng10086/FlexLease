# FlexLease 用户故事地图（信用与协作增强）

面向 `README.md`、`docs/` 全量文档以及当前代码（如 `backend/order-service`、`notification-service`、`frontend/src/pages/**`）梳理，先覆盖平台完整旅程（账号入驻→商品准备→消费下单→履约售后→结算分析），再针对以下五个主题叠加策略：

1. 个人信用：加/减分动作与阈值触发的平台处理。
2. 沟通：厂商与用户在各履约阶段的沟通方式与平台支撑。
3. 平台抽成：调研后的合理区间与适配策略。
4. 履约证明：发货、收货、退还等环节的取证需求。
5. 矛盾处理：预设方案与升级通道。

## 1. 角色画像

| 角色 | 目标 | 痛点 | 关键系统映射 |
| --- | --- | --- | --- |
| 平台管理员（风控/运营） | 控制信用风险、平衡抽成、快速裁决纠纷 | 缺少联动视图与标准化处罚，调解耗时 | `auth-service` 角色、`order-service` 管理接口、`notification-service` |
| 厂商（B 端） | 提升履约效率、降低纠纷成本、获得合理结算 | 沟通工具分散、无法证明出货状态、抽成不透明 | `vendor` 工作台、`product-service` 媒体、`payments/settlements` |
| 消费者（C 端） | 可信租赁体验、透明押金/信用政策、便捷沟通 | 不清楚信用规则、纠纷无从申诉、证明资料难保存 | `customer` 端下单、`orders/{id}` 时间线、`notifications` |

## 2. 用户故事地图（按旅程阶段）

| 阶段 | 核心活动（Backbone） | 管理员故事 | 厂商故事 | 消费者故事 |
| --- | --- | --- | --- | --- |
| A. 账号与入驻 | 角色注册、厂商资质审核、消费者建档 | 通过 `auth-service`/`user-service` 审核厂商申请、启用账号；配置菜单/权限 | 注册、提交入驻资料，跟踪审核状态 | 完成注册、实名认证，自动建立 `customers/profile` |
| B. 商品筹备 | 厂商配置商品/方案/SKU，管理员审核 | 处理 `/admin/products` 审核、控制类目政策 | 使用 `VendorProductWorkspace` 维护商品、库存、媒体，提交审核 | 在 Catalog 中可见审核通过的商品 | 
| C. 商品发现与试算 | Catalog 搜索、详情、购物车、订单预览 | 配置推荐位、监控曝光与 GMV；处理营销公告 | 关注商品曝光、库存与咨询；准备运营文案 | 浏览 `/catalog`、加入购物车、调用 `/orders/preview` 试算 |
| D. 下单与支付 | 创建订单、合并购物车、支付/退款 | `AdminOrderMonitorPage` 查看订单流、触发强制关闭；检查支付风控 | 根据通知及时处理订单、补齐合同条款 | 在 `CheckoutPage` 下单并通过 `payment-service` 自动/手动完成支付 |
| E. 履约与售后 | 发货、收货、续租、退租、买断 | 监控履约 SLA、审核异常订单、处理投诉 | 在 `VendorOrderWorkspace` 操作发货/审批，并管理库存补偿 | 在 `OrderDetailPage` 查看物流、上传取证、发起续租/退租/买断 |
| F. 结算与运营 | 结算对账、抽成、通知/看板、满意度 | 查看 `/analytics/dashboard`、`/payments/settlements`、通知模板；复盘纠纷 | 读取结算拆分、运营指标、通知；按需求申诉 | 查看合同/信用、通知历史，完成评价 |

## 3. 主题旅程（聚焦信用/沟通/抽成/证明/矛盾）

在整体旅程骨干上，进一步从五个主题视角观察各阶段的细化故事：

| 阶段 | 核心活动（Backbone） | 管理员故事 | 厂商故事 | 消费者故事 |
| --- | --- | --- | --- | --- |
| A. 注册与信用沉淀 | 绑定身份、初始信用授予、查看信用规则 | 维护信用模型与阈值；监控异常账号；通过 `user-service` 批量调级 | 在工作台看到平台信用要求与奖励；提交额外资质以争取更低抽成 | 查看个人信用评分与影响项；完成身份验证以提高初始分与押金减免 |
| B. 下单与确认 | 试算、提交订单、自动支付、首轮通知 | 根据信用分判断是否需要人工复核或提升押金比例；触发信用减分预警 | 设定接单 SLA、收到系统通知并在订单时间线回复 | 使用订单创建页看到信用对押金的影响；收到下单确认与沟通入口 |
| C. 履约与证明 | 发货、收货、租赁中巡检、退租/续租申请 | 审核样本订单的取证资料；抽检证明合规性 | 上传发货照片/视频并绑定防拆封条；在时间线中留存巡检证据；使用模板快速回复续租/退租 | 收货前查看发货证据；收货/退租时按指引上传多媒体证明并选择沟通方式 |
| D. 结算与抽成 | 结算核对、佣金计算、信用联动 | 设置行业/信用分的阶梯抽成；在 `payments/settlements` 导出对账 | 查看实时抽成比例及依据；申请季度评估以争取调档 | 在账单与合同中看到平台抽成影响（例如平台服务费、押金减免） |
| E. 冲突与调解 | 触发预设处理、记录仲裁、结案复盘 | 在纠纷面板查看各方提供的证据链；根据模板（重发、折扣、退押金）裁决 | 在订单详情里选择预设解决方案并上传补充证明；必要时请求平台介入 | 通过内置沟通渠道提交诉求，选择预设方案或升级至平台；查看信用扣分与可申诉条目 |
| F. 复盘与成长 | 信用变更、沟通回顾、满意度调研 | 运营看板新增信用分布、纠纷类型；触发通知模板鼓励良好行为 | 收到信用加分提醒；参考纠纷复盘改进流程 | 在通知中心看到信用积分明细、申诉入口与成功经验 |

> 每个阶段均复用现有 `order_event` 时间线与 `notification-service`，新增的故事会在后续章节映射到具体服务。

## 4. 主题策略详解

### 4.1 个人信用与分值策略

| 行为 | 加/减分 | 数据来源 | 平台自动处理 |
| --- | --- | --- | --- |
| 完成实名认证与多因子校验 | +10 | `auth-service` 登录 & 认证日志 | 初始押金比例降低 10% |
| 准时支付订单、无逾期 | +5 每单 | `payment-service` 成功回执 | 连续 3 单后触发 `notification-service` 奖励提醒 |
| 提前/按约归还并上传完整证明 | +8 | `order-service` 归还事件 + `order_proof` 媒体 | 押金自动退还缩短至 12 小时，并允许免人工质检抽检 |
| 逾期支付或超时归还（<3 天） | -8 | `order-maintenance` 调度日志 | 下次下单押金 +20%，同时推送整改通知 |
| 恶意拒收、拒不退还、经判定需赔偿 | -30 | 平台裁决记录 | 自动冻结下单权限 30 天，并通知管理员跟进 |
| 友好沟通解决纠纷（双方评分） | +3 | 新增纠纷模块 | 用于解锁“低押金免审核”权限 |

**阈值及动作**

- `>=90`（信用优享）：`OrderPreviewResponse` 允许押金减免 30%，并提供“快速审核”通道；`payments` 结算时平台抽成减 1 个百分点。
- `60~89`（标准管控）：照常流程。
- `40~59`（预警）：`order-service` 创建订单时增加 `requiresManualReview` 标记，管理员可在 `AdminOrderMonitorPage` 中筛选。
- `<40`（限制）：暂停售新租赁，仅允许处理在途订单，需在通知中心完成“整改任务”后申请恢复。

信用快照会写入：
1. `users.user_profile` 新增 `credit_score` 与 `credit_tier`。
2. `order.rental_order` 保留下单时的信用分，便于结算回溯。
3. `frontend` 在 `/app/checkout`、`/app/orders/:id`、`/app/overview` 提示信用影响。

### 4.2 沟通渠道（按流程拆解）

| 流程阶段 | 沟通触点 | 平台提供的能力 |
| --- | --- | --- |
| 下单前（试算/询价） | 商品详情页内的“咨询”入口、`notification-service` 站内信模板 | 新增 `order-service` 私信草稿 API，厂商可配置常见问题回复；访客消息仅存 72 小时 |
| 下单 & 支付 | 订单创建自动写入 `order_event`，双向通知 | 调整 `NotificationTemplate`，附上聊天入口链接、信用提示；管理员可在后台插入公告 |
| 发货 & 收货 | 物流填写页面 + 证据上传 | 在 `VendorOrderWorkspace` 的发货抽屉中新增“留言给用户”字段；用户确认收货前需阅览证据并可留言 |
| 租赁中 & 售后 | 续租/退租/买断流程 | 在 `OrderDetailPage` 中嵌入“会话组件”，展示申请状态、可选预设回复（见 4.5）；系统自动在超时节点推送提醒 |
| 退租 & 取证 | 退租申请表单 + 取证清单 | 表单自动拉取需要拍摄的角度、视频要求，提交后写入 `order_proof` |
| 纠纷升级 | 纠纷抽屉 + 平台客服桌面 | 管理员可将沟通记录导出；提供“立即致电”按钮记录电话纪要 |

### 4.3 平台抽成策略（调研结论）

调研国内 B2C 租赁平台（以京东企业租赁、爱租机的公开招商资料为参照）后，抽成区间多在 **5%~12%** 之间，3C 产品处于区间上限、家电和家居用品较低。

| 商品类型 | 推荐抽成 | 调整因子 | 平台说明 |
| --- | --- | --- | --- |
| 3C/智能设备 | 10%（优选 8~12%） | 厂商信用、履约 SLA、平台活动资源占用 | 信用优享厂商（信用>=90 且 3 个月无纠纷）可下调 2% |
| 家电/家居 | 6%（5~8%） | 物流由平台承担时 +1%；大件安装由厂商承担时 -1% | 在 `payments/settlements` 显示拆分细目 |
| 短租体验、饰品 | 8% 固定 | 单笔额低、履约频次高，需要更多平台客服 | 提供批量结算模板 |

抽成策略实现：
- `payment-service` 增加 `commission_rate` 字段，计算 `PLATFORM_COMMISSION` 拆分。
- `user-service` 为厂商配置 `commission_profile`（行业 + 信用档 + 指标）。
- `frontend` 的结算页面展示平台分成、厂商实收、信用折扣。

### 4.4 履约证明（取证清单）

| 节点 | 证明要求 | 存储设计 | 用户故事 |
| --- | --- | --- | --- |
| 厂商发货 | 3 张照片（外观、序列号、包装）、1 段 15 秒以内开机演示视频 | `product-service` 复用 `media_asset` 存储，`order-service` 通过 `order_proof` 表关联 | 厂商在发货抽屉中上传证明，系统校验分辨率与大小；上传完成后再允许提交运单 |
| 用户收货 | 开箱视频（含包装完好），签字照片 | 前端临时保存至浏览器，上传到 `order_proof` 并标记 `PROOF_TYPE=RECEIVE` | 用户必须上传后才能点击“确认收货”，且照片自动水印订单号 |
| 租赁中巡检（可选） | 设备使用状态照片、故障日志 | `order_event` 追加 `INSPECTION` 类型事件 | 厂商可发起巡检请求，用户上传后可获 +2 信用 |
| 退租寄出 | 包裹称重照片、快递面单、视频 | 同上 | 用户提交后自动触发厂商和管理员通知 |
| 厂商验收入库 | 厂家检测单、损坏照片 | 与库存 `inventory_snapshot` 关联 | 验收失败则在纠纷模块中转入仲裁 |

### 4.5 矛盾处理与升级

1. **预设选项**（在 `OrderDetailPage` 的纠纷抽屉中展示）：
   - `A`：重新发货 / 零件补发
   - `B`：部分退款 + 继续租赁
   - `C`：退租并扣减押金
   - `D`：买断优惠
2. **流程**：
   1. 一方发起纠纷 → 自动创建 `order_dispute`（新表）记录，生成 48 小时倒计时。
   2. 双方选择预设方案或上传自定义诉求，系统提示信用影响。
   3. 若 48 小时无共识，管理员介入：读取所有 `order_proof`+`order_event`，可添加调解建议。
   4. 管理员裁决 → 自动更新信用分与押金处理，触发 `notification-service` 模板，若任一方不服，可提交二次申诉（限制一次），由平台复核组处理。
3. **沟通渠道**：
   - 在纠纷抽屉内提供 `文本 + 图片 + 视频` 上传、电话纪要录入。
   - `notification-service` 新增模板 `DISPUTE_COUNTDOWN`、`DISPUTE_RESOLVED`。
4. **复盘**：纠纷结束后 24 小时推送满意度调查；管理员仪表盘新增纠纷漏斗与平均处理时长。

## 5. 数据与技术映射

- **数据库**：`users.user_profile`、`order.rental_order`、`order_event`、`order_proof`（新）、`order_dispute`（新）、`payment.payment_transaction` 扩展字段。
- **服务改造**：
  - `order-service`：扩充 `OrderEventType`、`RentalOrderResponse`；提供信用联动字段、预设沟通 API。
  - `notification-service`：新增模板 + 频道过滤 + 倒计时提醒。
  - `frontend`：`OverviewPage` 展示信用分布；`VendorOrderWorkspace`、`OrderDetailPage`、`NotificationCenterPage` 嵌入信用提示和沟通组件。
- **接口契约**：`/analytics/dashboard` 增加信用与纠纷统计；`/analytics/vendor/{id}` 展示厂商信用加权抽成；`/notifications/logs` 支持按 `contextType=DISPUTE` 过滤。

> 以上故事地图旨在保持 FlexLease 现有微服务边界不变，通过新增字段与轻量服务扩展实现 KISS 原则下的信用、沟通、抽成与纠纷闭环。部署层面复用现有 Docker Compose，无需新增中间件。

## 6. 后续实现清单

| 迭代 | 目标 | 核心交付 | 依赖服务 |
| --- | --- | --- | --- |
| Sprint 1 | 信用底座（50/100 分制） | `users.user_profile` 扩展、信用加减 API、前端信用徽章；在 `OrderPreview` 接入押金调整 | auth-service, user-service, frontend |
| Sprint 2 | 取证 & 沟通 MVP | `order_proof` 表、发货/收货上传、订单聊天（基于 `order_event` 扩展）；通知模板更新 | order-service, product-service, notification-service |
| Sprint 3 | 抽成策略 & 结算联动 | `commission_profile`、`payments/settlements` 拆分字段、前端展示；信用联动抽成折扣 | payment-service, user-service, frontend |
| Sprint 4 | 纠纷与仲裁 | `order_dispute` 模型、预设解决方案、管理员裁决面板、信用处罚自动化 | order-service, frontend, notification-service |
| Sprint 5 | 数据化与复盘 | 仪表盘新增信用/纠纷指标、满意度调研、脚本化报表 | order-service (analytics), frontend |

> 上述清单对应文档中的增强点，团队可按优先级排期实现。

## 7. Sprint 1 交付记录（本次迭代完成情况）

- **数据字段**：`users.user_profile` 扩展 `credit_score/credit_tier`，`order.rental_order` 持久化下单时的 `original_deposit_amount`、信用等级、押金调整系数与人工复核标记。
- **API 能力**：
  - `/api/v1/admin/users/{id}/credit-adjustments` 支持管理员按原因对信用分加/减分，自动按 0～100 区间裁剪并记录等级。
  - `/api/v1/internal/users/{id}/credit` 暴露给内部服务，order-service 通过 `X-Internal-Token` 拉取信用快照。
  - `/api/v1/orders/preview` 根据信用自动调整押金（>=90 减免 30%，40～59 上浮 20%，<40 拒绝下单），响应附加 `creditSnapshot` 与押金原价；`RentalOrderResponse` 同步返回信用字段。
- **前端呈现**：
  - Profile 页新增“信用档案”徽章，实时展示分值与等级提示。
  - Checkout 支付卡片展示押金原价、信用调整百分比及预警提示，保障用户感知押金变化与人工审核流程。
  - 订单创建后的押金/支付逻辑自动沿用调整结果，Playwright/E2E 可在现有流程下复用。

## 8. Sprint 2 交付记录（取证 & 沟通 MVP）

- **后端能力**
  - 新增 `order_proof` 表与 `/api/v1/orders/{id}/proofs` 列表/上传接口，支持 `SHIPMENT/RECEIVE/RETURN/INSPECTION/OTHER` 取证类型，文件落地 `storage/order-proofs` 并通过 `/proofs/**` 静态资源读取。
  - `OrderProofService` 统一处理多角色上传、鉴权与通知，上传成功后自动记录 `PROOF_UPLOADED` 事件并在响应中附带 `actorRole/fileUrl/uploadedAt` 元数据。
  - `order_event` 表扩展 `actor_role`，`RentalOrderService` 新增 `/orders/{id}/messages`，以 `COMMUNICATION_NOTE` 类型记录订单对话并触发站内信提醒。
  - 引入 `OrderTimelineService` 封装事件写入&消息推送，集成测试覆盖取证上传与留言校验，确保角色权限、文件存储与通知链路正确。

- **前端体验**
  - 消费者订单详情新增“取证资料”“沟通记录”卡片，支持查看多端凭证、按类型上传文件并在线留言，留言列表标注“我/厂商/平台”身份。
  - 厂商履约抽屉同步嵌入取证/沟通区块，可在发货抽屉中直接上传照片/视频、回复用户咨询并实时刷新时间线。
  - `orderService` 新增 `postOrderMessage`、`uploadOrderProof` API，UI 中为上传/留言提供 loading、错误提示与自动刷新，提升售后透明度。

- **通知与可见性**
  - 上传凭证与留言均向对端推送站内信，实现“上传即提醒”的取证闭环，并借由 `OrderEvent.actorRole` 让时间线与新卡片都能明确消息来源。
  - 结合 Sprint 1 的信用徽章，用户可在同一页面看到信用影响、凭证留存与沟通轨迹，平台内部也可通过事件流进一步扩展分析/风控。

## 9. Sprint 3 交付记录（抽成策略 & 结算联动）

- **用户服务**：在 `users.vendor` 增加 `industry_category/commission_base_rate/commission_credit_tier/commission_sla_score` 字段，抽象 `VendorCommissionProfile`。管理员可通过 `/api/v1/vendors/{id}/commission-profile` 配置行业、基础费率、信用档与 SLA 评分，内部服务可调用 `/api/v1/internal/vendors/{id}/commission-profile` 获取计算后的最终抽成比例；响应对外统一返回 `commissionRate` 与原始配置，厂商详情接口也会同步附带该信息。
- **支付服务**：引入 `VendorServiceClient` 在创建支付时自动拉取厂商抽成配置，`payment_transaction` 表新增 `commission_rate` 字段。`PaymentTransactionService` 会基于 `VENDOR_INCOME` 分账自动拆出 `PLATFORM_COMMISSION`，回写交易级抽成比例，并在结算统计中新增 `platformCommissionAmount`，`netAmount` 由“厂商可结算收入（租金/买断/违约金）- 厂商维度退款”计算，押金储备不再计入净值，确保厂商看到的是实际可得收益。
- **前端结算中心**：`/app/vendor/settlements` 表格增加“平台抽成”列与文案提示，结合新的结算接口字段将押金、租金、抽成、退款、净入账一并展示，方便财务复核抽成策略的实际影响。

## 10. Sprint 4 交付记录（纠纷与仲裁）

- **数据与领域**：新增 `order_dispute` 表（含 `status`、双方选择的预设方案、平台裁决、信用变动、申诉次数等字段）与 `OrderDispute` 聚合，`RentalOrderResponse`、`OrderEventType` 扩展 `DISPUTE_*` 事件，Flyway 版本 `V008__order_disputes.sql` 完成 schema 初始化。
- **后端 API**：`OrderDisputeService` + `OrderDisputeController` 落地 `/api/v1/orders/{orderId}/disputes/**`（创建、回应、仲裁升级、申诉）与 `/api/v1/admin/orders/{orderId}/disputes/{id}/resolve`（管理员裁决、自动写入信用扣分）。服务内复用时间线与通知链路，对应事件会推送站内信提醒对端。
- **信用联动**：`user-service` 的内部接口新增 `/api/v1/internal/users/{id}/credit-adjustments`，`UserProfileClient` 暴露 `adjustCredit`，管理员裁决时可一键扣减/奖励消费者信用；裁决结果同步到订单详情以便溯源。
- **前端改造**：
  - 消费者订单详情（`OrderDetailPage.vue`）新增“纠纷与仲裁”卡片，可发起纠纷、回应预设方案、申请仲裁或申诉并查看整条取证/通知链路。
  - 厂商工作台订单抽屉支持快速创建纠纷、给出处理方案、升级平台仲裁或发起申诉，同步复用时间线。
  - 管理端订单监控抽屉展示纠纷列表并提供“平台裁决”弹窗，支持选择预设方案、填写备注、指定信用扣分区间，一次性回写状态。
- **测试**：`RentalOrderServiceIntegrationTest` 增补 `shouldHandleDisputeLifecycle` 覆盖发起→回应→升级→管理员裁决+信用处罚的闭环；运行 `./mvnw -pl backend/order-service -am test` 全量通过（H2 + Flyway），确保新表结构与服务逻辑稳定。

## 11. Sprint 5 交付记录（数据化与复盘）

- **满意度调研闭环**：
  - `order-service` 引入 `order_satisfaction_survey` 表（Flyway `V009__order_satisfaction_survey.sql`）、`OrderSatisfactionSurvey` 聚合与 `OrderSurveyService`/`OrderSurveyController`，在纠纷双方达成一致或平台裁决时自动排程双角色调查。
  - 调查默认延迟 `flexlease.order.survey.reminder-delay-hours`（配置中心支持 env 覆盖），由 `OrderSurveyScheduler` 定时激活并在时间线追加 `SURVEY_INVITED/SURVEY_SUBMITTED` 事件，同时触发站内信邀请/感谢。
  - `RentalOrderResponse` 追加 `surveys` 字段，消费者与厂商通过 `/orders/{id}/surveys/{surveyId}/submit` 完成 1～5 分打分与评语上传；服务端校验角色身份、评分区间并在完成后推送通知。
  - 新增 `OrderSurveyServiceIntegrationTest` 配合 Mockito 的 `NotificationClient` 验证调研建档、激活与提交流程，杜绝懒加载问题。

- **信用/纠纷/满意度指标**：
  - `OrderAnalyticsService` 扩展 `CreditMetrics`、`DisputeMetrics`、`SurveyMetrics` 三种聚合，分别统计平均信用分+等级分布、纠纷状态 + 平均结案小时及调查待办/完成数量与均分。
  - `DashboardMetricsResponse`、`VendorMetricsResponse` 输出上述结构，`OrderDisputeRepository` 新增响应的分组/平均耗时查询，`OrderSatisfactionSurveyRepository` 添加状态/评分统计方法，`RentalOrderRepository` 汇总信用等级数据。
  - `OrderAnalyticsServiceIntegrationTest` 断言新指标与 Distributor 逻辑；`./mvnw -pl backend/order-service -am test` 全量通过。

- **前端复盘体验**：
  - `OverviewPage.vue` 在平台/厂商视角增加信用标签、纠纷态势、满意度调研卡片（复用 `creditTierLabel/creditTierColor`），实时展示平均分与待办数量。
  - 消费者 `OrderDetailPage.vue`、厂商 `VendorOrderWorkspacePage.vue` 均引入“满意度调查”卡片与评分弹窗，订单时间线、取证区块与纠纷卡片保持原样，动作完成后自动刷新订单。
  - `orderService.ts` 补充 `OrderSurvey` 类型与 `submitOrderSurvey` API，前端状态管理复用现有 `message`/`modal` 反馈。

- **报表与运维**：
  - 新增 `scripts/dashboard-report.mjs`，可通过 `FLEXLEASE_API_BASE` / `FLEXLEASE_API_TOKEN` 拉取 `/analytics/dashboard`，生成 Markdown 报表输出至 `reports/dashboard-*.md`。
  - `application.yml` 暴露 `flexlease.order.survey.*` 配置，方便在不同环境下调整调研延迟、激活批次与扫描频率。
