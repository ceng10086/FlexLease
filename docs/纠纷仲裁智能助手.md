# 纠纷仲裁智能助手（LLM + 人工裁决）

FlexLease 已实现一个“人机协作”的纠纷仲裁助手：当纠纷进入平台仲裁后，管理员可在裁决前请求外部 LLM（例如 DeepSeek OpenAI 兼容接口）生成结构化的仲裁建议，用于提效与口径一致；**最终裁决仍由管理员确认并提交**。

## 1. 结合点（只做一处）

结合在 **管理员裁决纠纷** 场景：

- 管理端：订单详情抽屉 →「纠纷与仲裁」→ 点击「生成仲裁建议」
- 后端：`order-service` 生成建议并返回结构化 JSON（只读，不改变纠纷状态）

## 2. 生成的内容（结构化输出）

助手会基于订单与纠纷上下文（时间线、沟通记录、取证元信息、平台规则摘要等）生成建议，前端会展示并可自动回填裁决表单：

- 事实摘要（summary）+ 要点（keyFacts）
- 缺失证据清单（missingEvidence）
- 建议裁决（recommendedDecision：方案/信用分变更/是否恶意/理由）
- 给双方的通知话术草稿（draftMessages）
- 风险提示（riskNotes）

说明：

- 不上传图片/视频本体（DeepSeek OpenAI 兼容接口无多模态），只提供文本与元信息。
- 当接入外部 LLM 时，后端要求 **LLM 返回合法 JSON**（使用 DeepSeek 的 JSON Output 模式）；若未配置 Key / 不可访问外网 / 调用失败，则会返回**离线模板化建议**（输出会标注“离线模式”），用于演示与排查，避免流程/测试被阻断。
- 输出语言要求：**除枚举值/字段名等固定值外，所有自然语言字段必须使用中文输出**（例如 `summary`、`rationale`、`draftMessages`、`riskNotes`）。
- 结果会落库缓存（`order.dispute_ai_suggestion`），同一纠纷默认复用；请求体 `force=true` 可强制重新生成。
  - 当后端提示词版本升级时（`promptVersion` 变化），服务端会自动重新生成一次，避免复用旧版本内容。

## 3. API（管理员）

- `POST /api/v1/admin/orders/{orderId}/disputes/{disputeId}/ai-suggestion`

请求体（可选）：

```json
{ "tone": "NEUTRAL", "force": false }
```

响应体（核心字段）：

```json
{
  "summary": "……",
  "recommendedDecision": { "option": "CUSTOM", "creditDelta": 0, "maliciousBehavior": false, "rationale": "……" },
  "model": "deepseek-chat",
  "generatedAt": "2025-01-01T00:00:00+08:00"
}
```

完整字段定义见：

- `docs/API设计.md`
- `backend/order-service/src/main/java/com/flexlease/order/dto/DisputeAiSuggestionResponse.java`

## 4. 配置（使用 .env，避免手动 export）

如需接入外部 LLM（非离线模板模式），建议使用仓库根目录 `.env`（已在 `.gitignore` 忽略）：

1. 复制示例并填写 Key：`cp .env.example .env`
2. 启动：`docker compose up --build`

相关变量（示例见 `.env.example`）：

- `FLEXLEASE_LLM_ENABLED`：`order-service` 的 `application.yml` 默认 `false`；`docker-compose.yml` 也默认 `false`（离线模板模式），如需接入外部 LLM 再通过 `.env` 显式置为 `true`。
- `FLEXLEASE_LLM_BASE_URL`（默认 `https://api.deepseek.com`）
- `FLEXLEASE_LLM_MODEL`（默认 `deepseek-chat`）
- `FLEXLEASE_LLM_API_KEY`

如不接入外部 LLM（例如无法访问外网/没有 Key），保持 `FLEXLEASE_LLM_ENABLED=false` 即可；此时“生成仲裁建议”会走离线模板输出，不影响演示与 E2E。
