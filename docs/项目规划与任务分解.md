# 智能化共享租赁平台项目规划与任务分解

## 1. 项目愿景与范围
- **愿景**：为 B 端厂商与 C 端消费者提供一个覆盖商品展示、租赁、支付、订单全生命周期的共享租赁平台。
- **核心范围**：面向 B2C 模式，支持普通租赁、先租后买、以租代售三类业务流程，覆盖账号/权限、商品、订单、支付、运营管理模块。
- **不在范围**：跨境物流、复杂风控评分、大数据推荐算法、真实支付通道对接（以模拟服务或沙箱代替）。

## 2. 关键角色与诉求
| 角色 | 诉求 | 主要功能 |
| ---- | ---- | -------- |
| 平台管理员 | 运营管理、风控、财务对账 | 用户与角色管理、厂商审核、订单监控、财务统计 |
| 厂商（B 端） | 发布商品、管理订单与库存 | 商品管理、租赁方案配置、订单处理、账单查看 |
| 消费者（C 端） | 便捷租赁、续租、退租、先租后买 | 商品浏览、下单、支付、续租、退租、订单查询 |

## 3. 功能结构分解
```
智能共享租赁平台
├─ 账号与权限中心
│  ├─ 用户注册/登录（B/C/Admin）
│  ├─ 多角色授权与菜单控制
│  └─ 审核及合规流程
├─ 商品与租赁方案管理
│  ├─ 厂商资料与资质
│  ├─ 商品基本信息、库存、图片
│  ├─ 租期/押金/租金方案配置（多模式）
│  └─ 商品上下架与审核
├─ 订单与租赁履约
│  ├─ 下单（普通/先租后买/以租代售）
│  ├─ 订单状态流转（待支付→待发货→履约→归还/买断）
│  ├─ 续租、退租、买断流程
│  └─ 售后（退款、异常处理）
├─ 支付与结算
│  ├─ 模拟支付/对接银行沙箱
│  ├─ 账务拆分（押金/租金/违约金）
│  └─ 财务对账与流水查询
├─ 数据看板与通知
│  ├─ 运营指标（租赁率、续租率、GMV）
│  ├─ 通知与消息（站内信）
│  └─ 日志审计
└─ 支撑能力
   ├─ 文件存储（商品图片、合同）
   ├─ 消息队列（订单事件、通知推送）
   └─ 定时任务（续租提醒、到期处理）
```

## 4. 技术方案概览
- **后端**：Java 21 + Spring Boot 3.3，Spring Cloud Netflix（Eureka + Gateway）统一注册/路由，Spring Security + JWT 负责鉴权，JPA/Hibernate + Flyway 管理 Schema，Redis 用于通知模板缓存。
- **消息与任务**：RabbitMQ 处理订单事件与通知订阅，Scheduler（Spring @Scheduled）负责待支付订单自动取消与库存补偿。
- **前端**：Vue 3 + Vite + TypeScript + Pinia + Ant Design Vue，多角色工作台与端到端体验回归。
- **数据与配置**：PostgreSQL 16 为所有业务库（按 schema 拆分），商品媒体落盘存储。统一 Docker Compose 编排 registry/gateway/所有微服务 + Nginx 前端，开发阶段可通过 `SPRING_PROFILES_ACTIVE` 切换 H2 或 PostgreSQL。
- **认证**：JWT（Access/Refresh）+ 内部 `X-Internal-Token`，认证服务提供内部接口用于账号状态与厂商 ID 绑定。

## 5. 微服务拆分
| 服务 | 职责 | 对应数据库 schema |
| ---- | ---- | ------------------ |
| registry-service | Eureka Server，提供服务注册发现 | 无 |
| gateway-service | Spring Cloud Gateway，统一路由转发（鉴权由各微服务负责） | 无 |
| auth-service | 账号注册、登录、令牌、内部账号管理 | auth |
| user-service | 厂商入驻、资料维护、用户档案 | users |
| product-service | 商品/方案/SKU/库存、前台目录、媒体存储、内部库存接口 | product |
| order-service | 订单/购物车/合同/运营指标、信用奖励、纠纷/调研调度，并向 user-service 暴露厂商履约指标 | "order" |
| payment-service | 支付/退款/分账/结算、自动回调订单服务 | payment |
| notification-service | 模板、通知日志、订阅订单事件并推送 | notification |
| frontend（SPA） | Vue 3 管理端，依赖 Gateway 暴露 API | 无 |

> 支付结算场景已在 payment-service 内完成分账与汇总，因此不再单独拆分 billing-service。通知服务使用 RabbitMQ 订阅订单事件并以 Redis 缓存模板。

## 6. 迭代计划（以 Git 三次大迭代为准）

本仓库的开发过程以 git 提交记录为准：共经历三次**大迭代**，当前处于第三次大迭代结束的状态。

| 大迭代 | 时间范围 | Git 范围（commit message） | 主要目标/关键交付 | 状态 |
| ---- | ---- | ---- | ---- | ---- |
| 第一次大迭代 | 2025-10-21～2025-11-19 | `chore: initialize repository` → `Fix auth-service login error responses` | 交付平台 MVP：认证与入驻、商品域、订单租赁闭环、支付与结算、通知与看板、网关与服务发现、前端多角色工作台；同时补齐购物车、库存预占、合同、幂等与权限边界等基础能力 | ✅ 已完成 |
| 第二次大迭代 | 2025-11-22～2025-12-19 | `Add end-to-end user story map and roadmap` → `test(e2e): read data from UI instead of network responses` | 交付信用/沟通/抽成/履约证明/矛盾处理能力，并引入 Playwright E2E 与演示指南，确保旅程 A-F 可回归 | ✅ 已完成 |
| 第三次大迭代 | 2025-12-20～2026-01-04 | `feat: add LLM dispute arbitration assistant` → `refactor(notification):keep in-app inbox only` | 交付纠纷仲裁智能助手与审计/回放日志，补齐仲裁 RBAC，并对通知域做收敛与文档同步 | ✅ 已完成 |

> 说明：早期提交中出现的 “Iteration 0～12” 属于更细粒度的里程碑拆分，主要发生在第一次大迭代期间；为避免与当前版本产生歧义，本文件不再按 0～12 逐条维护。

### 6.1 已完成里程碑回顾
- **第一次大迭代**：完成平台骨架与核心闭环（认证/入驻/商品/订单/支付/通知/看板），并落地网关与服务发现、购物车、库存预占、合同、幂等与权限边界等支撑能力。
- **第二次大迭代**：围绕“信用/沟通/抽成/履约证明/矛盾处理”补齐业务能力与 UI，完善纠纷流程与满意度调研，同时加入 Playwright E2E 保障演示与回归。
- **第三次大迭代**：新增纠纷仲裁智能助手（外部 LLM 可选、离线模板兜底）与审计/回放日志，强化仲裁相关 RBAC，并收敛通知为站内信实现。

## 7. 任务清单（Backlog）
- 需求
  - 用户故事撰写与优先级排序
  - 用例与流程图输出
- 架构与基础设施
  - Spring Cloud 多模块项目初始化
  - 数据库建模与迁移脚本
  - ✅ API 网关与服务注册
- 功能
  - 认证授权 + RBAC 菜单
  - 厂商入驻流程（提交→审核→启用）
  - ✅ 厂商资料维护、用户档案管理
  - ✅ 商品 CRUD、租赁方案配置
  - ✅ 下单预览/下单、订单状态流转（支付确认、发货、收货、续租、退租、买断）
  - ✅ 购物车、库存预占
  - ✅ 支付（押金/租金）、退款、结算汇总 API
  - ✅ 订单履约任务（定时）
  - ✅ 通知服务（站内信）
  - ✅ 运营仪表盘（基础指标）
  - ✅ 管理员订单监控与干预（强制关闭）
  - ✅ 订单沟通/取证/纠纷/满意度调查
  - ✅ 厂商抽成配置与支付分账联动
  - ✅ 信用事件自动化、商品咨询渠道、纠纷倒计时提醒与取证指引
  - 外部电商商品接口（已确认不纳入范围，平台以自建商品与模拟支付支撑核心业务）
- 测试
  - 单元测试（JUnit 5）
  - 集成测试（Spring Boot Test + H2，后续按需引入 Testcontainers）
  - ✅ 前端 E2E（关键路径脚本）
- DevOps
  - Docker Compose 脚本
  - GitHub Actions CI（构建+测试）
  - SonarLint/Checkstyle 规则
  - CLI 报表脚本：`scripts/dashboard-report.mjs` 可定期抓取 `/analytics/dashboard` 输出运营日报

## 8. 风险与缓解
| 风险 | 描述 | 缓解措施 |
| ---- | ---- | -------- |
| 业务复杂度膨胀 | 多模式租赁流程易复杂 | 先实现核心流程，复杂分支延后迭代 |
| 支付对接阻塞 | 实际支付渠道对接困难 | 使用模拟支付服务+沙箱 API |
| 微服务过度拆分 | 服务过多导致负担 | 优先单体内分包，后续再拆分部署 |
| 数据一致性 | 跨服务事务、库存冻结 | 采用事务消息或补偿机制，初版使用本地事务+状态机 |
| 性能瓶颈 | 高并发库存扣减 | 已在 product-service 中启用 `product_sku.version` 乐观锁 + 自动重试（可配 `flexlease.inventory.concurrency.*`），必要时再扩展 Redis/Lua |

## 9. 后续文档产出指引
- 《数据库设计》：表结构、索引、ER 模型
- 《API 设计》：接口路径、请求/响应、鉴权方式
- 《测试策略》：测试金字塔、关键用例
- 《部署与运维指南》：环境依赖、配置模板、监控指标

> 当前文档定位为实施指南，后续编码阶段将以此为依据分模块推进。
